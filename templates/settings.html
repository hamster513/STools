{% extends "base.html" %}

{% block title %}Настройки системы - STools{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/pages/admin.css?v=1.3">
{% endblock %}

<!-- Используем обработчики из base.html -->

{% block content %}
<main class="main-content">
    <div class="page-container">
        <div class="content-header">
            <h1><i class="fas fa-cogs"></i> Настройки системы</h1>
            <p>Общие настройки для всех сервисов STools</p>
        </div>

        <!-- Подключение к базе данных -->
        <div class="collapsible-block">
            <div class="collapsible-header" data-target="database-settings">
                <h3><i class="fas fa-database"></i> Подключение к базе данных</h3>
                <div class="collapsible-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="database-settings">
                <form id="database-settings-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="db-host">Хост базы данных:</label>
                        <input type="text" id="db-host" name="database_host" required>
                    </div>
                    <div class="form-group">
                        <label for="db-port">Порт:</label>
                        <input type="text" id="db-port" name="database_port" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="db-name">Имя базы данных:</label>
                        <input type="text" id="db-name" name="database_name" required>
                    </div>
                    <div class="form-group">
                        <label for="db-user">Пользователь:</label>
                        <input type="text" id="db-user" name="database_user" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="db-password">Пароль:</label>
                    <input type="password" id="db-password" name="database_password" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save"></i> Сохранить настройки БД
                    </button>
                    <button type="button" id="test-connection" class="btn btn-info btn-sm">
                        <i class="fas fa-plug"></i> Проверить подключение
                    </button>
                </div>
            </form>
            </div>
        </div>

        <!-- Общие настройки -->
        <div class="collapsible-block">
            <div class="collapsible-header" data-target="general-settings">
                <h3><i class="fas fa-sliders-h"></i> Общие настройки</h3>
                <div class="collapsible-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="general-settings">
                <form id="general-settings-form">
                <div class="form-group">
                    <label for="system-name">Название системы:</label>
                    <input type="text" id="system-name" name="system_name" value="STools" required>
                </div>
                <div class="form-group">
                    <label for="session-timeout">Таймаут сессии (минуты):</label>
                    <input type="number" id="session-timeout" name="session_timeout" min="5" max="1440" value="60" required>
                    <small>От 5 минут до 24 часов</small>
                </div>
                <div class="form-group">
                    <label for="max-file-size">Максимальный размер файла (MB):</label>
                    <input type="number" id="max-file-size" name="max_file_size" min="1" max="1024" value="100" required>
                    <small>Максимальный размер загружаемых файлов</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save"></i> Сохранить общие настройки
                    </button>
                </div>
            </form>
            </div>
        </div>

        <!-- Настройки безопасности -->
        <div class="collapsible-block">
            <div class="collapsible-header" data-target="security-settings">
                <h3><i class="fas fa-shield-alt"></i> Настройки безопасности</h3>
                <div class="collapsible-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="security-settings">
                <form id="security-settings-form">
                <div class="form-group">
                    <label for="password-min-length">Минимальная длина пароля:</label>
                    <input type="number" id="password-min-length" name="password_min_length" min="6" max="50" value="8" required>
                </div>
                <div class="form-group">
                    <label for="failed-login-attempts">Максимум неудачных попыток входа:</label>
                    <input type="number" id="failed-login-attempts" name="failed_login_attempts" min="3" max="10" value="5" required>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="require-password-change" name="require_password_change">
                    <label for="require-password-change">Требовать смену пароля при первом входе</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save"></i> Сохранить настройки безопасности
                    </button>
                </div>
            </form>
            </div>
        </div>

        <!-- Backup/Restore -->
        <div class="collapsible-block">
            <div class="collapsible-header" data-target="backup-restore">
                <h3><i class="fas fa-download"></i> Backup/Restore</h3>
                <div class="collapsible-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="backup-restore">
                <!-- Создание бэкапа -->
                <div class="backup-section">
                    <h4><i class="fas fa-save"></i> Создание бэкапа</h4>
                    <form id="backup-form">
                        <div class="form-group">
                            <label>Выберите таблицы для бэкапа:</label>
                            <div class="tables-selection" id="tables-selection">
                                <!-- Таблицы будут загружены динамически -->
                                <div class="loading">Загрузка списка таблиц...</div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm" id="create-backup-btn">
                                <i class="fas fa-download"></i> Создать бэкап
                            </button>
                        </div>
                    </form>
                    
                    <!-- Прогресс создания бэкапа -->
                    <div id="backup-progress" class="progress-section" style="display: none;">
                        <h5>Создание бэкапа...</h5>
                        <div class="progress">
                            <div class="progress-bar" id="backup-progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-status" id="backup-status">Подготовка...</div>
                    </div>
                </div>

                <!-- Список существующих бэкапов -->
                <div class="backups-list-section">
                    <h4><i class="fas fa-list"></i> Существующие бэкапы</h4>
                    <div class="backups-list" id="backups-list">
                        <!-- Список бэкапов будет загружен динамически -->
                        <div class="loading">Загрузка списка бэкапов...</div>
                    </div>
                </div>

                <!-- Восстановление из бэкапа -->
                <div class="restore-section">
                    <h4><i class="fas fa-upload"></i> Восстановление из бэкапа</h4>
                    <form id="restore-form">
                        <div class="form-group">
                            <label for="backup-file">Выберите файл бэкапа:</label>
                            <input type="file" id="backup-file" name="backup_file" accept=".tar.gz,.zip,.sql" required>
                            <small>Поддерживаются форматы: .tar.gz, .zip, .sql</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-warning btn-sm" id="restore-backup-btn">
                                <i class="fas fa-upload"></i> Восстановить
                            </button>
                        </div>
                    </form>
                    
                    <!-- Прогресс восстановления -->
                    <div id="restore-progress" class="progress-section" style="display: none;">
                        <h5>Восстановление...</h5>
                        <div class="progress">
                            <div class="progress-bar" id="restore-progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-status" id="restore-status">Подготовка...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Информация о системе -->
        <div class="collapsible-block">
            <div class="collapsible-header" data-target="system-info">
                <h3><i class="fas fa-info-circle"></i> Информация о системе</h3>
                <div class="collapsible-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="system-info">
                <div class="system-info">
                <div class="info-item">
                    <span class="info-label">Версия системы:</span>
                    <span class="info-value" id="system-version">{{ version }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Статус базы данных:</span>
                    <span class="info-value" id="db-status">Проверка...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Активных пользователей:</span>
                    <span class="info-value" id="active-users">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Время работы системы:</span>
                    <span class="info-value" id="system-uptime">-</span>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" id="refresh-info" class="btn btn-secondary btn-sm">
                    <i class="fas fa-sync-alt"></i> Обновить информацию
                </button>
                            </div>
            </div>
            </div>
        </div>
</main>

<!-- Уведомления -->
<div id="notifications" class="notifications"></div>

<!-- Скрипты -->
<script src="/static/js/settings.js?v={{ version }}"></script>
{% endblock %}
