# –û—Ç—á–µ—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ database.py

## ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!

### **–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:**

#### **1. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```
vulnanalizer/app/database/
‚îú‚îÄ‚îÄ __init__.py                    # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îú‚îÄ‚îÄ base.py                        # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ epss_repository.py             # –†–∞–±–æ—Ç–∞ —Å EPSS –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ exploitdb_repository.py        # –†–∞–±–æ—Ç–∞ —Å ExploitDB –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ cve_repository.py              # –†–∞–±–æ—Ç–∞ —Å CVE –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ hosts_repository.py            # –†–∞–±–æ—Ç–∞ —Å —Ö–æ—Å—Ç–∞–º–∏
‚îú‚îÄ‚îÄ background_tasks_repository.py # –†–∞–±–æ—Ç–∞ —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
‚îú‚îÄ‚îÄ settings_repository.py         # –†–∞–±–æ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
‚îî‚îÄ‚îÄ risk_calculation_service.py    # –†–∞—Å—á–µ—Ç —Ä–∏—Å–∫–æ–≤
```

#### **2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
- ‚úÖ **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª** –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- ‚úÖ **–£–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä** —Å 20 –¥–æ 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ö–µ–º—ã** vulnanalizer
- ‚úÖ **–ù–µ—Ç –æ—à–∏–±–æ–∫ "too many clients"**

#### **3. –°–æ–∑–¥–∞–Ω—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:**

**HostsRepository:**
- `get_hosts_count()` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ—Å—Ç–æ–≤
- `get_hosts()` - —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- `get_hosts_by_cve()` - —Ö–æ—Å—Ç—ã –ø–æ CVE
- `delete_all_hosts()` - —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤
- `insert_hosts_records_with_progress()` - –∏–º–ø–æ—Ä—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
- `get_hosts_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö–æ—Å—Ç–æ–≤

**BackgroundTasksRepository:**
- `create_task()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `get_task()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ ID
- `get_idle_tasks()` - –∑–∞–¥–∞—á–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ 'idle'
- `update_task()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `get_recent_tasks()` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `get_active_tasks()` - –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `get_completed_tasks()` - –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `cancel_task()` - –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏
- `cleanup_old_tasks()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á
- `get_background_task_by_type()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø—É
- `cancel_background_task()` - –æ—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø—É

**SettingsRepository:**
- `get_settings()` - –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `update_settings()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `get_setting()` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- `set_setting()` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**RiskCalculationService:**
- `calculate_risk_score_fast()` - –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∏—Å–∫–∞
- `process_cve_risk_calculation_optimized()` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ CVE
- `_get_epss_by_cve_fast()` - –±—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ EPSS –¥–∞–Ω–Ω—ã—Ö

#### **4. –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- ‚úÖ **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `get_db()`** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å –º–µ—Ç–æ–¥–∞–º–∏ —Å—Ç–∞—Ä–æ–≥–æ API
- ‚úÖ **–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã** –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ **–ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
  - `count_hosts_records()` ‚Üí `get_hosts_count()`
  - `get_settings()` ‚Üí `settings.get_settings()`
  - `insert_hosts_records_with_progress()` ‚Üí `hosts.insert_hosts_records_with_progress()`
  - `get_background_task_by_type()` ‚Üí `background_tasks.get_background_task_by_type()`
  - `cancel_background_task()` ‚Üí `background_tasks.cancel_background_task()`
  - `get_background_tasks_by_status()` ‚Üí `background_tasks.get_background_tasks_by_status()`
  - `count_epss_records()` ‚Üí `epss.count_epss_records()`
  - `count_exploitdb_records()` ‚Üí `exploitdb.count_exploitdb_records()`
  - `count_cve_records()` ‚Üí `cve.count_cve_records()`
  - `create_background_task()` ‚Üí `background_tasks.create_task()`
  - `search_hosts()` - –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

#### **API —Ç–µ—Å—Ç—ã:**
- ‚úÖ `/api/health` - 200 OK
- ‚úÖ `/api/hosts/status` - 200 OK (999 —Ö–æ—Å—Ç–æ–≤)
- ‚úÖ `/api/background-tasks/status` - 200 OK (10 –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á)
- ‚úÖ `/api/epss/status` - 200 OK (290,230 –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ `/api/exploitdb/status` - 200 OK (46,429 –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ `/api/cve/status` - 200 OK (210,163 –∑–∞–ø–∏—Å–µ–π)

#### **–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ **1 –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- ‚úÖ **–ù–µ—Ç –æ—à–∏–±–æ–∫ "too many clients"**
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

#### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∏—Å–∫–æ–≤** —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–Ω–µ—à–Ω–∏—Ö API –≤—ã–∑–æ–≤–æ–≤
- ‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** –≤ RiskCalculationService

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
5. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å:** –ö–æ–¥ —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏

### **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:** –ó–∞–º–µ–Ω–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
2. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã:** Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ API –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ To-dos:**

- ‚úÖ **database_refactor_1:** –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å DatabaseBase —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ **database_refactor_2:** –°–æ–∑–¥–∞—Ç—å EPSSRepository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å EPSS –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **database_refactor_3:** –°–æ–∑–¥–∞—Ç—å ExploitDBRepository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ExploitDB –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **database_refactor_4:** –°–æ–∑–¥–∞—Ç—å CVERepository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CVE –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **database_refactor_5:** –°–æ–∑–¥–∞—Ç—å HostsRepository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö–æ—Å—Ç–∞–º–∏
- ‚úÖ **database_refactor_6:** –°–æ–∑–¥–∞—Ç—å BackgroundTasksRepository –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- ‚úÖ **database_refactor_7:** –°–æ–∑–¥–∞—Ç—å RiskCalculationService –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–æ–≤
- ‚úÖ **database_refactor_8:** –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö (–æ–±–µ—Å–ø–µ—á–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

### **–°—Ç–∞—Ç—É—Å:**
üü¢ **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**
- –í—Å–µ API —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–µ—Ç –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
