-- Миграция для исправления таблицы exploitdb
-- Добавляем недостающие колонки и исправляем структуру

-- Добавляем недостающие колонки
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS file_path TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS date_added DATE;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS codes TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS tags TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS aliases TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS screenshot_url TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS application_url TEXT;
ALTER TABLE exploitdb ADD COLUMN IF NOT EXISTS source_url TEXT;

-- Удаляем колонку cve если она существует (она не нужна в новой схеме)
ALTER TABLE exploitdb DROP COLUMN IF EXISTS cve;

-- Делаем exploit_id уникальным и NOT NULL
ALTER TABLE exploitdb ALTER COLUMN exploit_id SET NOT NULL;

-- Добавляем уникальное ограничение (если не существует)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'exploitdb_exploit_id_unique'
    ) THEN
        ALTER TABLE exploitdb ADD CONSTRAINT exploitdb_exploit_id_unique UNIQUE (exploit_id);
    END IF;
END $$;

-- Создаем новые индексы
CREATE INDEX IF NOT EXISTS idx_exploitdb_exploit_id ON exploitdb(exploit_id);
CREATE INDEX IF NOT EXISTS idx_exploitdb_type ON exploitdb(type);
CREATE INDEX IF NOT EXISTS idx_exploitdb_platform ON exploitdb(platform);

-- Удаляем старые индексы если они существуют
DROP INDEX IF EXISTS idx_exploitdb_cve;
