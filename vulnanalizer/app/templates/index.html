<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnAnalizer - Анализ уязвимостей</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    
    <!-- Основные CSS файлы -->
    <link rel="stylesheet" href="/static/css/main.css?v=6.26">
    <link rel="stylesheet" href="/static/css/pages/vulnanalizer.css?v=4.4">
            <link rel="stylesheet" href="/vulnanalizer/css-debug/collapsible.css?v=4.4&nocache={{ range(1, 999999) | random }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Мета-теги для кэширования -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body class="light-theme">
    <!-- Верхняя панель -->
    <div class="top-panel">
        <div class="system-tabs">
            <a href="/vulnanalizer/" class="system-tab active" id="vulnanalizer-tab">
                <div class="system-tab-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="system-tab-info">
                    <span class="system-tab-name">VulnAnalizer</span>
                    <span class="system-tab-desc">Анализ безопасности</span>
                </div>
            </a>
            <a href="/loganalizer/" class="system-tab" id="loganalizer-tab">
                <div class="system-tab-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="system-tab-info">
                    <span class="system-tab-name">LogAnalizer</span>
                    <span class="system-tab-desc">Анализ логов</span>
                </div>
            </a>
        </div>
        
        <div class="top-panel-right">
            <!-- Меню настроек -->
            <div class="dropdown-container">
                <button id="settings-toggle" class="dropdown-button">
                    <i class="fas fa-cog"></i>
                </button>
                <div id="settings-dropdown" class="dropdown-menu">
                    <a href="#" id="users-link" class="dropdown-item">
                        <i class="fas fa-users"></i>
                        <span>Пользователи</span>
                    </a>
                    <a href="#" id="background-tasks-link" class="dropdown-item">
                        <i class="fas fa-tasks"></i>
                        <span>Управление очередями</span>
                    </a>
                    <a href="#" id="settings-link" class="dropdown-item">
                        <i class="fas fa-cogs"></i>
                        <span>Настройки системы</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <div class="version-info">
                        <i class="fas fa-code-branch"></i>
                        <span id="app-version">v{{ version }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Меню пользователя -->
            <div class="dropdown-container">
                <button id="user-toggle" class="dropdown-button">
                    <i class="fas fa-user"></i>
                </button>
                <div id="user-dropdown" class="dropdown-menu">
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <span id="user-name" class="user-name">Пользователь</span>
                            <span class="user-role">Администратор</span>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="theme-link" class="dropdown-item">
                        <i class="fas fa-moon"></i>
                        <span id="theme-text">Темная</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="logout-link" class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Выйти</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Боковая панель -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-toggle" id="sidebar-toggle">
            <i class="fas fa-chevron-left"></i>
        </div>
        <nav class="sidebar-nav">
            <div class="sidebar-tabs">
                <a href="#" class="sidebar-tab active" data-page="analysis">
                    <div class="sidebar-tab-icon">
                        <i class="fas fa-search-plus"></i>
                    </div>
                    <span class="sidebar-tab-title">Поиск</span>
                </a>
                <a href="#" class="sidebar-tab" data-page="hosts">
                    <div class="sidebar-tab-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <span class="sidebar-tab-title">Импорт</span>
                </a>
                <a href="#" class="sidebar-tab" data-page="settings">
                    <div class="sidebar-tab-icon">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <span class="sidebar-tab-title">Настройки</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Основной контент -->
    <main class="main-content">
        <div class="page-container">
            <!-- Страница анализа -->
            <div id="analysis-page" class="page-content active">
                <div class="analysis-container content-block">
                    <div class="hosts-search-form">
                        <h3>Критерии поиска</h3>
                        <form id="hosts-search-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hostname-search">Имя хоста:</label>
                                    <input type="text" id="hostname-search" name="hostname" placeholder="server.example.com">
                                </div>
                                <div class="form-group">
                                    <label for="ip-search">IP адрес:</label>
                                    <input type="text" id="ip-search" name="ip_address" placeholder="192.168.1.1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cve-host-search">CVE:</label>
                                    <input type="text" id="cve-host-search" name="cve" placeholder="CVE-2021-44228">
                                </div>
                                <div class="form-group">
                                    <label for="criticality-search">Критичность:</label>
                                    <select id="criticality-search" name="criticality">
                                        <option value="">Все</option>
                                        <option value="Critical">Critical</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="exploits-only" name="exploits_only">
                                    <label for="exploits-only">Только с эксплойтами</label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="epss-only" name="epss_only">
                                    <label for="epss-only">Только с EPSS</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="results-per-page">Записей на странице:</label>
                                    <select id="results-per-page" name="limit">
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100" selected>100</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sort-by">Сортировка:</label>
                                    <select id="sort-by" name="sort_by">
                                        <option value="">По умолчанию</option>
                                        <option value="risk_score_desc">По риску (убывание)</option>
                                        <option value="risk_score_asc">По риску (возрастание)</option>
                                        <option value="cvss_desc">По CVSS (убывание)</option>
                                        <option value="cvss_asc">По CVSS (возрастание)</option>
                                        <option value="epss_score_desc">По EPSS (убывание)</option>
                                        <option value="epss_score_asc">По EPSS (возрастание)</option>
                                        <option value="exploits_count_desc">По количеству эксплойтов (убывание)</option>
                                        <option value="exploits_count_asc">По количеству эксплойтов (возрастание)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i> Найти
                                </button>
                                <button type="button" id="clear-hosts-results" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-times"></i> Очистить
                                </button>
                                <button type="button" id="export-hosts" class="btn btn-success btn-sm">
                                    <i class="fas fa-file-excel"></i> Экспорт в Excel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Отдельный контейнер для результатов поиска -->
                <div class="hosts-search-results-container content-block content-block-no-margin">
                    <!-- Заголовок таблицы с подписями колонок -->
                                         <div class="hosts-table-header">
                         <div class="host-item single-line">
                             <div class="host-name">Host</div>
                             <div class="host-ip">IP</div>
                             <div class="host-criticality">Severity</div>
                             <div class="host-cve">CVE</div>
                             <div class="host-cvss">CVSS</div>
                             <div class="host-status">EPSS</div>
                             <div class="host-exploits">PoC</div>
                             <div class="host-msf">MSF</div>
                             <div class="host-risk">Risk</div>
                         </div>
                     </div>
                    <div id="hosts-search-results" class="hosts-results">
                        <!-- Результаты поиска хостов будут загружены динамически -->
                    </div>
                    <!-- Пагинация -->
                    <div id="hosts-pagination" class="pagination-container" style="display: none;">
                        <div class="pagination-info">
                            <span id="pagination-info">Показано 0 из 0 записей</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="prev-page" class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-chevron-left"></i> Предыдущая
                            </button>
                            <span id="page-numbers" class="page-numbers"></span>
                            <button id="next-page" class="btn btn-secondary btn-sm" disabled>
                                Следующая <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Страница импорта хостов -->
            <div id="hosts-page" class="page-content">
                <div class="content-header">
                    <h2>Импорт хостов</h2>
                    <p>Загрузка и обработка данных о хостах</p>
                </div>
                
                <div class="hosts-container content-block">
                    <h3><i class="fas fa-server"></i> Импорт хостов из MP VM</h3>
                    <form id="hosts-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="hosts-file">Загрузить файл хостов:</label>
                            <input type="file" id="hosts-file" name="file" accept=".csv,.zip,.gz,.gzip" required>
                            <small>Поддерживаемые форматы: CSV, ZIP, GZIP</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm" id="hosts-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>

                            <button type="button" id="update-hosts-parallel-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-sync-alt"></i> <span class="btn-text">Полное обновление</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="cancel-update-btn" class="btn btn-danger btn-sm" style="display:none;">
                                <i class="fas fa-stop"></i> <span class="btn-text">Остановить обновление</span>
                            </button>
                        </div>
                    </form>
                    <div id="hosts-status" style="margin-top:2rem;"></div>
                    
                    <!-- Прогресс-бар импорта -->
                    <div id="import-progress-container" style="display:none; margin-top:2rem;">
                        <h4>Прогресс импорта</h4>
                        <div class="operation-status">
                            <div class="operation-step">
                                <span id="current-step-text">Подготовка...</span>
                            </div>
                            <div class="operation-progress-bar">
                                <div id="progress-bar-fill" class="operation-progress-fill" style="width: 0%"></div>
                                <div class="operation-progress-text" id="overall-progress-text">0%</div>
                            </div>
                            <div class="operation-details">
                                <div class="operation-item">
                                    <span class="operation-label">Всего записей:</span>
                                    <span id="total-records-text">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Прогресс фонового обновления -->
                    <div id="background-update-progress-container" style="display:none; margin-top:2rem;">
                        <h4>Прогресс обновления данных</h4>
                        <div class="operation-status">
                            <div class="operation-step">
                                <span id="background-current-step-text">Инициализация...</span>
                            </div>
                            <div class="operation-progress-bar">
                                <div id="background-progress-bar-fill" class="operation-progress-fill" style="width: 0%"></div>
                                <div class="operation-progress-text" id="background-overall-progress-text">0%</div>
                            </div>
                            <div class="operation-details">
                                <div class="operation-item">
                                    <span class="operation-label">Обработано CVE:</span>
                                    <span id="background-processed-cves-text">0</span>
                                </div>
                                <div class="operation-item">
                                    <span class="operation-label">Всего CVE:</span>
                                    <span id="background-total-cves-text">0</span>
                                </div>
                                <div class="operation-item">
                                    <span class="operation-label">Обновлено хостов:</span>
                                    <span id="background-updated-hosts-text">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Страница настроек -->
            <div id="settings-page" class="page-content">
                <div class="content-header">
                    <h2>Настройки</h2>
                    <p>Конфигурация системы</p>
                </div>
                
                <div class="settings-container">
                    <!-- Настройки производительности -->
                    <div class="collapsible-block">
                        <div class="collapsible-header" data-target="performance-settings">
                            <h3><i class="fas fa-tachometer-alt"></i> Настройки производительности</h3>
                            <div class="collapsible-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapsible-content" id="performance-settings">
                            <form id="performance-form">
                            <div class="form-group">
                                <label for="vulnanalizer-max-concurrent-requests">Максимум одновременных запросов к БД:</label>
                                <input type="number" id="vulnanalizer-max-concurrent-requests" name="max_concurrent_requests" min="1" max="10" value="3" required>
                                <small>Рекомендуется: 1-5. Больше запросов = быстрее, но больше нагрузка на БД</small>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-save"></i> Сохранить
                                </button>
                            </div>
                        </form>
                        </div>
                    </div>

                    <!-- Настройки расчета риска -->
                    <div class="collapsible-block">
                        <div class="collapsible-header" data-target="risk-settings">
                            <h3>
                                <i class="fas fa-calculator"></i> Расчет риска
                                <button type="button" class="btn btn-link btn-sm formula-btn" id="show-risk-formula" title="Показать формулу расчета">
                                    <i class="fas fa-square-root-alt"></i>
                                </button>
                            </h3>
                            <div class="collapsible-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapsible-content" id="risk-settings">
                            <!-- Подменю Порог риска -->
                            <div class="submenu-block">
                                <div class="submenu-header" data-target="threshold-submenu">
                                    <h4><i class="fas fa-exclamation-triangle"></i> Порог риска</h4>
                                    <div class="submenu-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                                <div class="submenu-content" id="threshold-submenu">
                                    <form id="threshold-form">
                                        <div class="form-group">
                                            <label for="risk-threshold">Порог риска (красная зона): <span id="threshold-value">75</span>%</label>
                                            <input type="range" id="risk-threshold" name="risk_threshold" min="0" max="100" value="75" class="threshold-slider">
                                            <small>Значения выше этого порога будут отображаться в красной зоне</small>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-save"></i> Сохранить порог
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Подменю Impact -->
                            <div class="submenu-block">
                                <div class="submenu-header" data-target="impact-submenu">
                                    <h4><i class="fas fa-chart-line"></i> Impact настройки</h4>
                                    <div class="submenu-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                                <div class="submenu-content" id="impact-submenu">
                                    <form id="impact-form">
                                        <div class="cvss-section">
                                            <h5>Impact Множители</h5>
                                            
                                            <div class="cvss-group">
                                                <h6>Критичность ресурса</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="impact-resource-criticality-critical">Critical:</label>
                                                        <input type="number" id="impact-resource-criticality-critical" name="impact_resource_criticality_critical" 
                                                               step="0.01" min="0" max="1" value="0.33" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="impact-resource-criticality-high">High:</label>
                                                        <input type="number" id="impact-resource-criticality-high" name="impact_resource_criticality_high" 
                                                               step="0.01" min="0" max="1" value="0.25" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="impact-resource-criticality-medium">Medium:</label>
                                                        <input type="number" id="impact-resource-criticality-medium" name="impact_resource_criticality_medium" 
                                                               step="0.01" min="0" max="1" value="0.2" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="impact-resource-criticality-none">None:</label>
                                                        <input type="number" id="impact-resource-criticality-none" name="impact_resource_criticality_none" 
                                                               step="0.01" min="0" max="1" value="0.2" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>Наличие конфиденциальных данных</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="impact-confidential-data-yes">Есть:</label>
                                                        <input type="number" id="impact-confidential-data-yes" name="impact_confidential_data_yes" 
                                                               step="0.01" min="0" max="1" value="0.33" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="impact-confidential-data-no">Отсутствуют:</label>
                                                        <input type="number" id="impact-confidential-data-no" name="impact_confidential_data_no" 
                                                               step="0.01" min="0" max="1" value="0.2" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>Доступ из сети интернет</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="impact-internet-access-yes">Доступен:</label>
                                                        <input type="number" id="impact-internet-access-yes" name="impact_internet_access_yes" 
                                                               step="0.01" min="0" max="1" value="0.33" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="impact-internet-access-no">Недоступен:</label>
                                                        <input type="number" id="impact-internet-access-no" name="impact_internet_access_no" 
                                                               step="0.01" min="0" max="1" value="0.2" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-save"></i> Сохранить Impact
                                            </button>
                                            <button type="button" id="reset-impact-defaults" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-undo"></i> Сбросить к значениям по умолчанию
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Подменю CVSS -->
                            <div class="submenu-block">
                                <div class="submenu-header" data-target="cvss-submenu">
                                    <h4><i class="fas fa-shield-alt"></i> CVSS параметры</h4>
                                    <div class="submenu-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                                <div class="submenu-content" id="cvss-submenu">
                                    <form id="cvss-form">
                                        <div class="cvss-section">
                                            <h5>CVSS v3 Множители</h5>
                                            
                                            <div class="cvss-group">
                                                <h6>Attack Vector (AV)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v3-av-network">NETWORK:</label>
                                                        <input type="number" id="cvss-v3-av-network" name="cvss_v3_attack_vector_network" 
                                                               step="0.01" min="0" max="2" value="1.20" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-av-adjacent">ADJACENT:</label>
                                                        <input type="number" id="cvss-v3-av-adjacent" name="cvss_v3_attack_vector_adjacent" 
                                                               step="0.01" min="0" max="2" value="1.10" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-av-local">LOCAL:</label>
                                                        <input type="number" id="cvss-v3-av-local" name="cvss_v3_attack_vector_local" 
                                                               step="0.01" min="0" max="2" value="0.95" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-av-physical">PHYSICAL:</label>
                                                        <input type="number" id="cvss-v3-av-physical" name="cvss_v3_attack_vector_physical" 
                                                               step="0.01" min="0" max="2" value="0.85" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>Privileges Required (PR)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v3-pr-none">NONE:</label>
                                                        <input type="number" id="cvss-v3-pr-none" name="cvss_v3_privileges_required_none" 
                                                               step="0.01" min="0" max="2" value="1.20" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-pr-low">LOW:</label>
                                                        <input type="number" id="cvss-v3-pr-low" name="cvss_v3_privileges_required_low" 
                                                               step="0.01" min="0" max="2" value="1.00" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-pr-high">HIGH:</label>
                                                        <input type="number" id="cvss-v3-pr-high" name="cvss_v3_privileges_required_high" 
                                                               step="0.01" min="0" max="2" value="0.85" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>User Interaction (UI)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v3-ui-none">NONE:</label>
                                                        <input type="number" id="cvss-v3-ui-none" name="cvss_v3_user_interaction_none" 
                                                               step="0.01" min="0" max="2" value="1.15" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v3-ui-required">REQUIRED:</label>
                                                        <input type="number" id="cvss-v3-ui-required" name="cvss_v3_user_interaction_required" 
                                                               step="0.01" min="0" max="2" value="0.90" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cvss-section">
                                            <h5>CVSS v2 Множители (если нет v3)</h5>
                                            
                                            <div class="cvss-group">
                                                <h6>Access Vector (AV)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v2-av-network">NETWORK:</label>
                                                        <input type="number" id="cvss-v2-av-network" name="cvss_v2_access_vector_network" 
                                                               step="0.01" min="0" max="2" value="1.20" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-av-adjacent">ADJACENT_NETWORK:</label>
                                                        <input type="number" id="cvss-v2-av-adjacent" name="cvss_v2_access_vector_adjacent_network" 
                                                               step="0.01" min="0" max="2" value="1.10" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-av-local">LOCAL:</label>
                                                        <input type="number" id="cvss-v2-av-local" name="cvss_v2_access_vector_local" 
                                                               step="0.01" min="0" max="2" value="0.95" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>Access Complexity (AC)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v2-ac-low">LOW:</label>
                                                        <input type="number" id="cvss-v2-ac-low" name="cvss_v2_access_complexity_low" 
                                                               step="0.01" min="0" max="2" value="1.10" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-ac-medium">MEDIUM:</label>
                                                        <input type="number" id="cvss-v2-ac-medium" name="cvss_v2_access_complexity_medium" 
                                                               step="0.01" min="0" max="2" value="1.00" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-ac-high">HIGH:</label>
                                                        <input type="number" id="cvss-v2-ac-high" name="cvss_v2_access_complexity_high" 
                                                               step="0.01" min="0" max="2" value="0.90" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="cvss-group">
                                                <h6>Authentication (Au)</h6>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="cvss-v2-au-none">NONE:</label>
                                                        <input type="number" id="cvss-v2-au-none" name="cvss_v2_authentication_none" 
                                                               step="0.01" min="0" max="2" value="1.15" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-au-single">SINGLE:</label>
                                                        <input type="number" id="cvss-v2-au-single" name="cvss_v2_authentication_single" 
                                                               step="0.01" min="0" max="2" value="1.00" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="cvss-v2-au-multiple">MULTIPLE:</label>
                                                        <input type="number" id="cvss-v2-au-multiple" name="cvss_v2_authentication_multiple" 
                                                               step="0.01" min="0" max="2" value="0.90" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-save"></i> Сохранить CVSS
                                            </button>
                                            <button type="button" id="reset-cvss-defaults" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-undo"></i> Сбросить к значениям по умолчанию
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Подменю ExploitDB -->
                            <div class="submenu-block">
                                <div class="submenu-header" data-target="exdb-submenu">
                                    <h4><i class="fas fa-bug"></i> ExploitDB параметры</h4>
                                    <div class="submenu-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                                <div class="submenu-content" id="exdb-submenu">
                                    <form id="exdb-form">
                                        <div class="exdb-section">
                                            <h5>ExploitDB Множители</h5>
                                            
                                            <div class="exdb-group">
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="exdb-remote">remote:</label>
                                                        <input type="number" id="exdb-remote" name="exdb_remote" 
                                                               step="0.01" min="0" max="2" value="1.3" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="exdb-webapps">webapps:</label>
                                                        <input type="number" id="exdb-webapps" name="exdb_webapps" 
                                                               step="0.01" min="0" max="2" value="1.2" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="exdb-dos">dos:</label>
                                                        <input type="number" id="exdb-dos" name="exdb_dos" 
                                                               step="0.01" min="0" max="2" value="0.85" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="exdb-local">local:</label>
                                                        <input type="number" id="exdb-local" name="exdb_local" 
                                                               step="0.01" min="0" max="2" value="1.05" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="exdb-hardware">hardware:</label>
                                                        <input type="number" id="exdb-hardware" name="exdb_hardware" 
                                                               step="0.01" min="0" max="2" value="1.0" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-actions">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save"></i> Сохранить ExploitDB
                                                </button>
                                                <button type="button" id="reset-exdb-defaults" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-undo"></i> Сбросить к значениям по умолчанию
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Подменю Metasploit -->
                            <div class="submenu-block">
                                <div class="submenu-header" data-target="msf-submenu">
                                    <h4><i class="fas fa-tools"></i> Metasploit параметры</h4>
                                    <div class="submenu-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                                <div class="submenu-content" id="msf-submenu">
                                    <form id="msf-form">
                                        <div class="msf-section">
                                            <h5>Metasploit Множители</h5>
                                            
                                            <div class="msf-group">
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="msf-excellent">excellent:</label>
                                                        <input type="number" id="msf-excellent" name="msf_excellent" 
                                                               step="0.01" min="0" max="2" value="1.3" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-good">good:</label>
                                                        <input type="number" id="msf-good" name="msf_good" 
                                                               step="0.01" min="0" max="2" value="1.25" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-normal">normal:</label>
                                                        <input type="number" id="msf-normal" name="msf_normal" 
                                                               step="0.01" min="0" max="2" value="1.2" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-average">average:</label>
                                                        <input type="number" id="msf-average" name="msf_average" 
                                                               step="0.01" min="0" max="2" value="1.1" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-low">low:</label>
                                                        <input type="number" id="msf-low" name="msf_low" 
                                                               step="0.01" min="0" max="2" value="0.8" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-unknown">unknown:</label>
                                                        <input type="number" id="msf-unknown" name="msf_unknown" 
                                                               step="0.01" min="0" max="2" value="0.8" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="msf-manual">manual:</label>
                                                        <input type="number" id="msf-manual" name="msf_manual" 
                                                               step="0.01" min="0" max="2" value="1.0" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-actions">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save"></i> Сохранить Metasploit
                                                </button>
                                                <button type="button" id="reset-msf-defaults" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-undo"></i> Сбросить к значениям по умолчанию
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Настройки VM MaxPatrol -->
                <div class="collapsible-block">
                    <div class="collapsible-header" data-target="vm-settings">
                        <h3><i class="fas fa-server"></i> Интеграция с MaxPatrol VM</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="vm-settings">
                        <form id="vm-settings-form">
                        <div class="form-group">
                            <label for="vm-enabled">Включить интеграцию:</label>
                            <select id="vm-enabled" name="vm_enabled" required>
                                <option value="false">Отключено</option>
                                <option value="true">Включено</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vm-host">Хост VM:</label>
                            <input type="text" id="vm-host" name="vm_host" placeholder="msk01vm23.corp.local" required>
                            <small>Адрес сервера MaxPatrol VM</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-username">Имя пользователя:</label>
                            <input type="text" id="vm-username" name="vm_username" placeholder="username" required>
                            <small>Логин для доступа к VM API</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-password">Пароль:</label>
                            <input type="password" id="vm-password" name="vm_password" placeholder="password" required>
                            <small>Пароль для доступа к VM API</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-client-secret">Client Secret:</label>
                            <input type="password" id="vm-client-secret" name="vm_client_secret" placeholder="client_secret" required>
                            <small>Секретный ключ для OAuth2 аутентификации</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm" id="vm-settings-btn">
                                <i class="fas fa-save"></i> Сохранить VM
                            </button>
                            <button type="button" id="vm-test-connection-btn" class="btn btn-info">
                                <i class="fas fa-plug"></i> Тест подключения
                            </button>
                        </div>
                    </form>
                    </div>
                </div>
                
                <!-- EPSS -->
                <div class="epss-container collapsible-block">
                    <div class="collapsible-header" data-target="epss-settings">
                        <h3>Загрузка базы EPSS</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="epss-settings">
                        <form id="epss-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="epss-file">Загрузить CSV-файл:</label>
                            <input type="file" id="epss-file" name="file" accept=".csv" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm" id="epss-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="epss-download-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-cloud-download-alt"></i> <span class="btn-text">Скачать с сайта</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="epss-preview-btn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-eye"></i> Просмотр данных
                            </button>
                        </div>
                    </form>
                    <div id="epss-status" style="margin-top:2rem;"></div>
                    </div>
                </div>

                <!-- ExploitDB -->
                <div class="exploitdb-container collapsible-block">
                    <div class="collapsible-header" data-target="exploitdb-settings">
                        <h3>Загрузка базы ExploitDB</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="exploitdb-settings">
                        <form id="exploitdb-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="exploitdb-file">Загрузить CSV-файл:</label>
                            <input type="file" id="exploitdb-file" name="file" accept=".csv" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm" id="exploitdb-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="exploitdb-download-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-cloud-download-alt"></i> <span class="btn-text">Скачать с сайта</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="exploitdb-preview-btn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-eye"></i> Просмотр данных
                            </button>
                        </div>
                    </form>
                    <div id="exploitdb-status" style="margin-top:2rem;"></div>
                    </div>
                </div>

                <!-- Metasploit -->
                <div class="metasploit-container collapsible-block">
                    <div class="collapsible-header" data-target="metasploit-settings">
                        <h3><i class="fas fa-bug"></i> Загрузка базы Metasploit</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="metasploit-settings">
                        <form id="metasploit-upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="metasploit-file">Загрузить JSON-файл:</label>
                                <input type="file" id="metasploit-file" name="file" accept=".json" required>
                                <small>Файл modules_metadata_base.json с GitHub Metasploit</small>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-sm" id="metasploit-upload-btn">
                                    <i class="fas fa-upload"></i> <span class="btn-text">Загрузить JSON</span>
                                    <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                                </button>
                                <button type="button" id="metasploit-download-btn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-cloud-download-alt"></i> <span class="btn-text">Скачать с GitHub</span>
                                    <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                                </button>
                                <button type="button" id="metasploit-cancel-btn" class="btn btn-danger btn-sm" style="display: none;">
                                    <i class="fas fa-stop"></i> <span class="btn-text">Остановить загрузку</span>
                                    <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                                </button>
                                <button type="button" id="metasploit-urls-btn" class="btn btn-info btn-sm">
                                    <i class="fas fa-link"></i> Ссылка для скачивания
                                </button>
                                <button type="button" id="metasploit-preview-btn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-eye"></i> Просмотр данных
                                </button>
                            </div>
                        </form>
                        <div id="metasploit-status" style="margin-top:2rem;"></div>
                    </div>
                </div>

                <!-- CVE -->
                <div class="cve-container collapsible-block">
                    <div class="collapsible-header" data-target="cve-settings">
                        <h3><i class="fas fa-bug"></i> Управление базой CVE</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="cve-settings">
                    
                    <!-- Выбор лет для загрузки -->
                    <div class="form-group mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" id="toggle-year-selector">
                            <i class="fas fa-calendar"></i> Выбрать годы для загрузки
                            <i class="fas fa-chevron-down ms-1"></i>
                        </button>
                        <div class="year-selector" id="year-selector" style="display: none;">
                            <div class="year-grid" id="year-grid">
                                <!-- Годы будут добавлены через JavaScript -->
                            </div>
                            <div class="year-controls mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-years">
                                    Выбрать все
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="select-recent-years">
                                    Последние 5 лет
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-years">
                                    Очистить
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Кнопки управления -->
                    <div class="form-actions">
                        <button id="download-cve-btn" class="btn btn-primary btn-sm">
                            <i class="fas fa-download"></i> Загрузить CVE
                        </button>
                        <button id="cancel-cve-btn" class="btn btn-danger btn-sm" style="display: none;">
                            <i class="fas fa-stop"></i> Отменить загрузку
                        </button>
                        <button type="button" id="cve-urls-btn" class="btn btn-info btn-sm">
                            <i class="fas fa-link"></i> Ссылки для скачивания
                        </button>
                        <button type="button" id="cve-preview-btn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-eye"></i> Просмотр данных
                        </button>
                    </div>
                    
                    <!-- Статус загрузки -->
                    <div id="cve-status" class="mt-3"></div>
                    
                    <!-- CVE Status -->
                    <div class="mt-4">
                        <h4><i class="fas fa-info-circle"></i> Статус базы CVE</h4>
                        <div id="cve-count"></div>
                    </div>
                    
                    <!-- Загрузка файлов (legacy) -->
                    <div class="mt-4">
                        <h4><i class="fas fa-upload"></i> Загрузка файлов</h4>
                        <form id="cve-upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="cve-file">Загрузить JSON-файл:</label>
                                <input type="file" id="cve-file" name="file" accept=".json,.gz" required>
                                <small>Поддерживаемые форматы: JSON, GZ (архив)</small>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-sm" id="cve-upload-btn">
                                    <i class="fas fa-upload"></i> <span class="btn-text">Загрузить файл</span>
                                    <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    </div>
                </div>

                <!-- Очистка таблиц -->
                <div class="clear-container collapsible-block">
                    <div class="collapsible-header" data-target="clear-settings">
                        <h3>Очистка таблиц</h3>
                        <div class="collapsible-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="collapsible-content" id="clear-settings">
                    <div class="clear-actions">
                        <div class="clear-item">
                            <h4>Хосты</h4>
                            <p>Удалить все записи хостов из базы данных</p>
                            <button type="button" id="clear-hosts-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Очистить хосты
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>EPSS</h4>
                            <p>Удалить все записи EPSS из базы данных</p>
                            <button type="button" id="clear-epss-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Очистить EPSS
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>ExploitDB</h4>
                            <p>Удалить все записи ExploitDB из базы данных</p>
                            <button type="button" id="clear-exploitdb-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Очистить ExploitDB
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>CVE</h4>
                            <p>Удалить все записи CVE из базы данных</p>
                            <button type="button" id="clear-cve-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Очистить CVE
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>Metasploit</h4>
                            <p>Удалить все записи Metasploit из базы данных</p>
                            <button type="button" id="clear-metasploit-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Очистить Metasploit
                            </button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Модальное окно с формулой расчета риска -->
    <div id="risk-formula-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-square-root-alt"></i> Формула расчета риска</h3>
                <button type="button" class="modal-close" id="close-risk-formula">&times;</button>
            </div>
            <div class="modal-body">
                <div class="formula-section">
                    <h4>🎯 Основная формула</h4>
                    <div class="formula-box">
                        <div class="formula-main">
                            <span class="formula-text">Risk = EPSS × (CVSS ÷ 10) × Impact × CVE_param × ExDB_param × MSF_param</span>
                        </div>
                        <div class="formula-note">
                            Где: <strong>Risk</strong> - итоговый риск в процентах (0-100%)
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>🔧 Расчет CVE_param</h4>
                    <div class="formula-box">
                        <div class="formula-main">
                            <span class="formula-text">CVE_param = F_AV × F_PR × F_UI (CVSS v3)</span>
                        </div>
                        <div class="formula-main">
                            <span class="formula-text">CVE_param = F_AV2 × F_AC2 × F_AU2 (CVSS v2)</span>
                        </div>
                        <div class="formula-note">
                            Если CVE_param не удалось рассчитать или результат равен 0, используется значение 1.0
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>📊 Расчет Impact</h4>
                    <div class="formula-box">
                        <div class="formula-main">
                            <span class="formula-text">Impact = Resource_Criticality + Confidential_Data + Internet_Access</span>
                        </div>
                    </div>
                    
                    <div class="impact-weights">
                        <div class="weight-group">
                            <h5>⚖️ Критичность ресурса:</h5>
                            <ul>
                                <li><strong>Critical:</strong> 0.33</li>
                                <li><strong>High:</strong> 0.25</li>
                                <li><strong>Medium:</strong> 0.2</li>
                                <li><strong>None:</strong> 0.2</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>🔒 Конфиденциальные данные:</h5>
                            <ul>
                                <li><strong>Есть:</strong> 0.33</li>
                                <li><strong>Отсутствуют:</strong> 0.2</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>🌐 Доступ из интернета:</h5>
                            <ul>
                                <li><strong>Доступен:</strong> 0.33</li>
                                <li><strong>Недоступен:</strong> 0.2</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>⚙️ CVSS v3 Множители</h4>
                    <div class="cvss-weights">
                        <div class="weight-group">
                            <h5>🎯 Attack Vector (AV):</h5>
                            <ul>
                                <li><strong>NETWORK:</strong> 1.20</li>
                                <li><strong>ADJACENT:</strong> 1.10</li>
                                <li><strong>LOCAL:</strong> 0.95</li>
                                <li><strong>PHYSICAL:</strong> 0.85</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>🔐 Privileges Required (PR):</h5>
                            <ul>
                                <li><strong>NONE:</strong> 1.20</li>
                                <li><strong>LOW:</strong> 1.00</li>
                                <li><strong>HIGH:</strong> 0.85</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>👤 User Interaction (UI):</h5>
                            <ul>
                                <li><strong>NONE:</strong> 1.15</li>
                                <li><strong>REQUIRED:</strong> 0.90</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>⚙️ CVSS v2 Множители (если нет v3)</h4>
                    <div class="cvss-weights">
                        <div class="weight-group">
                            <h5>🎯 Access Vector (AV):</h5>
                            <ul>
                                <li><strong>NETWORK:</strong> 1.20</li>
                                <li><strong>ADJACENT_NETWORK:</strong> 1.10</li>
                                <li><strong>LOCAL:</strong> 0.95</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>🔐 Access Complexity (AC):</h5>
                            <ul>
                                <li><strong>LOW:</strong> 1.10</li>
                                <li><strong>MEDIUM:</strong> 1.00</li>
                                <li><strong>HIGH:</strong> 0.90</li>
                            </ul>
                        </div>
                        
                        <div class="weight-group">
                            <h5>👤 Authentication (Au):</h5>
                            <ul>
                                <li><strong>NONE:</strong> 1.15</li>
                                <li><strong>SINGLE:</strong> 1.00</li>
                                <li><strong>MULTIPLE:</strong> 0.90</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>🐛 ExploitDB Множители</h4>
                    <div class="cvss-weights">
                        <div class="weight-group">
                            <h5>🎯 Тип эксплойта:</h5>
                            <ul>
                                <li><strong>remote:</strong> 1.3</li>
                                <li><strong>webapps:</strong> 1.2</li>
                                <li><strong>dos:</strong> 0.85</li>
                                <li><strong>local:</strong> 1.05</li>
                                <li><strong>hardware:</strong> 1.0</li>
                            </ul>
                        </div>
                        <div class="formula-note">
                            Если информация об эксплойте отсутствует, используется множитель 1.0
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>🛠️ Metasploit Множители</h4>
                    <div class="cvss-weights">
                        <div class="weight-group">
                            <h5>🎯 Ранг модуля:</h5>
                            <ul>
                                <li><strong>excellent:</strong> 1.3</li>
                                <li><strong>good:</strong> 1.25</li>
                                <li><strong>normal:</strong> 1.2</li>
                                <li><strong>average:</strong> 1.1</li>
                                <li><strong>low:</strong> 0.8</li>
                                <li><strong>unknown:</strong> 0.8</li>
                                <li><strong>manual:</strong> 1.0</li>
                            </ul>
                        </div>
                        <div class="formula-note">
                            Если информация о модуле Metasploit отсутствует, используется множитель 1.0
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>📈 Пример расчета</h4>
                    <div class="example-box">
                        <div class="example-data">
                            <p><strong>Исходные данные:</strong></p>
                            <ul>
                                <li>EPSS = 0.5 (50% вероятность эксплуатации)</li>
                                <li>CVSS = 8.0 (высокая критичность)</li>
                                <li>Критичность ресурса = Critical (0.33)</li>
                                <li>Конфиденциальные данные = Есть (0.33)</li>
                                <li>Доступ из интернета = Доступен (0.33)</li>
                                <li>CVSS v3: AV=NETWORK(1.20), PR=NONE(1.20), UI=NONE(1.15)</li>
                                <li>ExploitDB тип = remote (1.3)</li>
                                <li>Metasploit ранг = excellent (1.3)</li>
                            </ul>
                        </div>
                        
                        <div class="example-calculation">
                            <p><strong>Расчет:</strong></p>
                            <div class="calculation-steps">
                                <div class="step">1. Impact = 0.33 + 0.33 + 0.33 = <strong>0.99</strong></div>
                                <div class="step">2. CVE_param = 1.20 × 1.20 × 1.15 = <strong>1.656</strong></div>
                                <div class="step">3. ExDB_param = remote = <strong>1.3</strong></div>
                                <div class="step">4. MSF_param = excellent = <strong>1.3</strong></div>
                                <div class="step">5. Risk = 0.5 × (8.0 ÷ 10) × 0.99 × 1.656 × 1.3 × 1.3 = <strong>1.108</strong></div>
                                <div class="step">6. Risk Score = min(1, 1.108) × 100 = <strong>100%</strong></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>🎚️ Шкала риска</h4>
                    <div class="risk-scale">
                        <div class="risk-level low">
                            <span class="level-name">Низкий риск</span>
                            <span class="level-range">0-20%</span>
                        </div>
                        <div class="risk-level medium">
                            <span class="level-name">Средний риск</span>
                            <span class="level-range">20-40%</span>
                        </div>
                        <div class="risk-level high">
                            <span class="level-name">Высокий риск</span>
                            <span class="level-range">40-70%</span>
                        </div>
                        <div class="risk-level critical">
                            <span class="level-name">Критический риск</span>
                            <span class="level-range">70-100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notifications" class="notifications"></div>

    <!-- Модальное окно для описания CVE -->
    <div id="cve-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="cve-modal-title">Описание CVE</h3>
            <span class="close" id="cve-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="cve-modal-loading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin"></i> Загрузка...
            </div>
            <div id="cve-modal-content" style="display: none;">
                <div class="cve-info">
                    <div class="cve-header">
                        <h4 id="cve-id"></h4>
                        <div class="cve-scores">
                            <div id="cvss-v3-info" class="cvss-info"></div>
                            <div id="cvss-v2-info" class="cvss-info"></div>
                        </div>
                    </div>
                    <div class="cve-dates">
                        <div id="published-date" class="cve-date"></div>
                        <div id="modified-date" class="cve-date"></div>
                    </div>
                    <div class="cve-description">
                        <h5>Описание:</h5>
                        <p id="cve-description-text"></p>
                    </div>
                </div>
            </div>
            <div id="cve-modal-error" style="display: none; text-align: center; color: var(--error-color);">
                <i class="fas fa-exclamation-triangle"></i>
                <p id="cve-error-message"></p>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра Metasploit -->
    <div id="metasploit-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="metasploit-modal-title">Просмотр данных Metasploit (первые 20 записей)</h3>
            <span class="close" id="metasploit-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="metasploit-modal-content">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра EPSS -->
    <div id="epss-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="epss-modal-title">Просмотр данных EPSS (первые 20 записей)</h3>
            <span class="close" id="epss-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="epss-modal-content">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра ExploitDB -->
    <div id="exploitdb-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="exploitdb-modal-title">Просмотр данных ExploitDB (первые 20 записей)</h3>
            <span class="close" id="exploitdb-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="exploitdb-modal-content">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра CVE -->
    <div id="cve-preview-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="cve-preview-modal-title">Просмотр данных CVE (первые 20 записей)</h3>
            <span class="close" id="cve-preview-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="cve-preview-modal-content">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра расчета риска -->
    <div id="risk-modal" class="modal-content" style="display: none;">
        <div class="modal-header">
            <h3 id="risk-modal-title">Детали расчета риска</h3>
            <span class="close" id="risk-modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="risk-modal-loading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin"></i> Загрузка...
            </div>
            <div id="risk-modal-content" style="display: none;">
                <div class="risk-info">
                    <div class="risk-header">
                        <div id="risk-host-info" class="risk-host-info"></div>
                        <div id="risk-cve-info" class="risk-cve-info"></div>
                    </div>
                    <div class="risk-summary">
                        <div class="risk-score-display">
                            <h4>Общий риск:</h4>
                            <div id="risk-score-value" class="risk-score"></div>
                            <div id="risk-level-value" class="risk-level"></div>
                        </div>
                    </div>
                    <div id="risk-formula" class="risk-formula"></div>
                    <div id="risk-calculation-details" class="risk-calculation-details"></div>
                    <div id="risk-factors" class="risk-factors"></div>
                </div>
            </div>
            <div id="risk-modal-error" style="display: none; text-align: center; color: var(--error-color);">
                <i class="fas fa-exclamation-triangle"></i>
                <p id="risk-error-message"></p>
            </div>
        </div>
    </div>

    <!-- Скрипты -->
    <script src="/static/js/ui-manager.js?v=6.3"></script>
        <script src="/vulnanalizer/static/js/modules/notifications.js?v=2.1"></script>
    <script src="/vulnanalizer/static/js/modules/api.js?v=2.4"></script>
    <script src="/vulnanalizer/static/js/modules/auth.js?v=2.1"></script>
            <script src="/vulnanalizer/static/js/modules/hosts.js?v=4.3"></script>
        <script src="/vulnanalizer/static/js/modules/epss.js?v=2.3"></script>
        <script src="/vulnanalizer/static/js/modules/exploitdb.js?v=2.1"></script>
        <script src="/vulnanalizer/static/js/modules/cve.js?v=2.1"></script>
    <script src="/vulnanalizer/static/js/modules/cve-manager.js?v=1.0"></script>
                    <script src="/vulnanalizer/static/js/modules/cve-modal.js?v=1.5"></script>
        <script src="/vulnanalizer/static/js/modules/risk-modal.js?v=1.6"></script>
        <script src="/vulnanalizer/static/js/modules/settings.js?v=3.1"></script>
        <script src="/vulnanalizer/static/js/modules/base-modal.js?v=2.1"></script>
        <script src="/vulnanalizer/static/js/modules/metasploit.js?v=1.7"></script>
        <script src="/vulnanalizer/static/js/modules/metasploit-modal.js?v=1.2"></script>
        <script src="/vulnanalizer/static/js/modules/epss-modal.js?v=1.3"></script>
        <script src="/vulnanalizer/static/js/modules/exploitdb-modal.js?v=1.5"></script>
        <script src="/vulnanalizer/static/js/modules/cve-preview-modal.js?v=1.3"></script>
<script src="/vulnanalizer/static/js/modules/vm.js?v=2.0"></script>
        <script src="/vulnanalizer/static/js/modules/navigation.js?v=2.1"></script>
<script src="/vulnanalizer/static/js/modules/utils.js?v=2.1"></script>
            <script src="/vulnanalizer/static/js/app.js?v=7.1"></script>

    <!-- Инициализация UI -->
    <script>
        // Функция для инициализации accordion и подменю
        function initializeAccordion() {
            // Обработчики для accordion-секций
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            
            collapsibleHeaders.forEach((header, index) => {
                
                // Убираем класс collapsed при инициализации
                header.classList.remove('collapsed');
                
                header.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetId = header.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const arrow = header.querySelector('.collapsible-arrow i');
                    
                    if (content) {
                        if (content.style.display === 'none' || content.style.display === '') {
                            // Разворачиваем
                            content.style.display = 'block';
                            header.classList.remove('collapsed');
                            if (arrow) arrow.className = 'fas fa-chevron-down';
                        } else {
                            // Сворачиваем
                            content.style.display = 'none';
                            header.classList.add('collapsed');
                            if (arrow) arrow.className = 'fas fa-chevron-right';
                        }
                    }
                });
            });

            // Обработчики для подменю
            const submenuHeaders = document.querySelectorAll('.submenu-header');
            
            submenuHeaders.forEach((header, index) => {
                
                header.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetId = header.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const arrow = header.querySelector('.submenu-arrow i');
                    
                    if (content) {
                        if (content.classList.contains('active')) {
                            // Сворачиваем
                            content.classList.remove('active');
                            if (arrow) arrow.className = 'fas fa-chevron-right';
                        } else {
                            // Разворачиваем
                            content.classList.add('active');
                            if (arrow) arrow.className = 'fas fa-chevron-down';
                        }
                    }
                });
            });
        }

        // Функция для инициализации вкладок
        function initializeTabs() {
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const pageContents = document.querySelectorAll('.page-content');
            
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Убираем активный класс со всех вкладок
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    pageContents.forEach(p => p.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке
                    tab.classList.add('active');
                    
                    // Показываем соответствующую страницу
                    const pageName = tab.getAttribute('data-page');
                    const targetPage = document.getElementById(pageName + '-page');
                    if (targetPage) {
                        targetPage.classList.add('active');
                    }
                });
            });
        }

        // Функция для инициализации модальных окон
        function initializeModals() {
            
            const modalCloses = document.querySelectorAll('.modal-close, .close');
            modalCloses.forEach(close => {
                close.addEventListener('click', () => {
                    const modal = close.closest('.modal-content');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Закрытие модальных окон по клику вне их
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-content')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Основная инициализация
        function initializeUI() {
            // Инициализируем все компоненты
            initializeAccordion();
            initializeTabs();
            initializeModals();
        }

        // Запускаем инициализацию после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeUI);
        } else {
            initializeUI();
        }

        // Дополнительная инициализация через небольшую задержку
        setTimeout(initializeUI, 100);
    </script>
</body>
</html>
