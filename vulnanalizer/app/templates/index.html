<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnAnalizer - Анализ уязвимостей</title>
    <link rel="icon" type="image/svg+xml" href="/vulnanalizer/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/style.css?v=2.3">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="light-theme">
    <!-- Верхняя панель переключения сервисов -->
    <div class="top-bar modern-top-bar">
        <div class="service-switcher">
            <a href="/vulnanalizer/" class="service-link active modern-service-link" id="vulnanalizer-link">
                <div class="service-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="service-info">
                    <span class="service-name">VulnAnalizer</span>
                    <span class="service-desc">Анализ безопасности</span>
                </div>
            </a>
            <a href="/loganalizer/" class="service-link modern-service-link" id="loganalizer-link">
                <div class="service-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="service-info">
                    <span class="service-name">LogAnalizer</span>
                    <span class="service-desc">Анализ логов</span>
                </div>
            </a>
        </div>
        <div class="top-bar-right">
            <div class="settings-menu">
                <button id="settings-toggle" class="settings-btn modern-btn">
                    <i class="fas fa-cog"></i>
                </button>
                <div id="settings-dropdown" class="settings-dropdown modern-dropdown">
                    <a href="#" id="users-link" class="dropdown-item">
                        <i class="fas fa-users"></i>
                        <span>Пользователи</span>
                    </a>
                </div>
            </div>
            <div class="user-menu">
                <button id="user-toggle" class="user-btn modern-btn">
                    <i class="fas fa-user"></i>
                </button>
                <div id="user-dropdown" class="user-dropdown modern-dropdown">
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <span id="user-name" class="user-name">Пользователь</span>
                            <span class="user-role">Администратор</span>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="theme-link" class="dropdown-item">
                        <i class="fas fa-sun"></i>
                        <span id="theme-text">Светлая</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="logout-link" class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Выйти</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
                <!-- Боковое меню -->
        <aside class="sidebar modern-sidebar" id="sidebar">
            <div class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#" class="nav-link active modern-nav-link" data-page="analysis">
                            <div class="nav-icon">
                                <i class="fas fa-search-plus"></i>
                            </div>
                            <span class="nav-title">Поиск</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link modern-nav-link" data-page="hosts">
                            <div class="nav-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <span class="nav-title">Импорт</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link modern-nav-link" data-page="settings">
                            <div class="nav-icon">
                                <i class="fas fa-sliders-h"></i>
                            </div>
                            <span class="nav-title">Настройки</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Основной контент -->
        <main class="main-content">

            <!-- Страница анализа -->
            <div id="analysis-page" class="page-content active">
                <div class="analysis-container">
                    <div class="hosts-search-form">
                        <h3>Критерии поиска</h3>
                        <form id="hosts-search-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hostname-search">Имя хоста:</label>
                                    <input type="text" id="hostname-search" name="hostname" placeholder="server.example.com">
                                </div>
                                <div class="form-group">
                                    <label for="ip-search">IP адрес:</label>
                                    <input type="text" id="ip-search" name="ip_address" placeholder="192.168.1.1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cve-host-search">CVE:</label>
                                    <input type="text" id="cve-host-search" name="cve" placeholder="CVE-2021-44228">
                                </div>
                                <div class="form-group">
                                    <label for="criticality-search">Критичность:</label>
                                    <select id="criticality-search" name="criticality">
                                        <option value="">Все</option>
                                        <option value="Critical">Critical</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="exploits-only" name="exploits_only" style="width: auto; height: auto; margin: 0; padding: 0;">
                                <label for="exploits-only" style="display: inline; margin-left: 4px;">Только с эксплойтами</label>
                            </div>
                            <div class="form-actions">
                                                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Найти
                            </button>
                                <button type="button" id="clear-hosts-results" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Очистить
                                </button>
                                <button type="button" id="export-hosts" class="btn btn-success">
                                    <i class="fas fa-file-excel"></i> Экспорт в Excel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Отдельный контейнер для результатов поиска -->
                <div class="hosts-search-results-container">
                    <div id="hosts-search-results" class="hosts-results">
                        <!-- Результаты поиска хостов будут загружены динамически -->
                    </div>
                </div>
            </div>

            <!-- Страница пользователей -->
            <div id="users-page" class="page-content">
                <div class="users-dashboard">
                    <div class="users-header">
                        <div class="header-left">
                            <h2><i class="fas fa-users"></i> Пользователи</h2>
                            <p class="users-subtitle">Управление пользователями системы</p>
                        </div>
                        <div class="header-right">
                            <button id="add-user-btn" class="btn btn-primary btn-modern">
                                <i class="fas fa-plus"></i>
                                <span>Добавить пользователя</span>
                            </button>
                        </div>
                    </div>

                    <div class="users-stats">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="total-users">0</div>
                                <div class="stat-label">Всего пользователей</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon active">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="active-users">0</div>
                                <div class="stat-label">Активных</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon admin">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="admin-users">0</div>
                                <div class="stat-label">Администраторов</div>
                            </div>
                        </div>
                    </div>

                    <div class="users-content">
                        <div class="users-filters">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="users-search" placeholder="Поиск пользователей...">
                            </div>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">
                                    <i class="fas fa-list"></i> Все
                                </button>
                                <button class="filter-btn" data-filter="active">
                                    <i class="fas fa-user-check"></i> Активные
                                </button>
                                <button class="filter-btn" data-filter="admin">
                                    <i class="fas fa-user-shield"></i> Админы
                                </button>
                            </div>
                        </div>

                        <div class="users-grid" id="users-list">
                            <!-- Список пользователей будет загружен динамически -->
                        </div>
                    </div>
                </div>

                <!-- Модальное окно для добавления/редактирования пользователя -->
                <div id="user-modal" class="modal">
                    <div class="modal-content modern-modal">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-user-plus"></i>
                                <h3 id="modal-title">Добавить пользователя</h3>
                            </div>
                            <button class="modal-close" id="close-modal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="user-form" class="modern-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="username">Имя пользователя *</label>
                                        <div class="input-wrapper">
                                            <i class="fas fa-user"></i>
                                            <input type="text" id="username" name="username" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <div class="input-wrapper">
                                            <i class="fas fa-envelope"></i>
                                            <input type="email" id="email" name="email">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="password">Пароль *</label>
                                        <div class="input-wrapper">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" id="password" name="password" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="confirm-password">Подтвердите пароль *</label>
                                        <div class="input-wrapper">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" id="confirm-password" name="confirm-password" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group checkbox-group">
                                        <label class="checkbox-label modern">
                                            <input type="checkbox" id="is-admin" name="is-admin">
                                            <span class="checkmark"></span>
                                            <i class="fas fa-user-shield"></i>
                                            <span>Администратор</span>
                                        </label>
                                    </div>
                                    
                                    <div class="form-group checkbox-group">
                                        <label class="checkbox-label modern">
                                            <input type="checkbox" id="is-active" name="is-active" checked>
                                            <span class="checkmark"></span>
                                            <i class="fas fa-user-check"></i>
                                            <span>Активен</span>
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-modern" id="cancel-btn">
                                <i class="fas fa-times"></i> Отмена
                            </button>
                            <button type="button" class="btn btn-primary btn-modern" id="save-btn">
                                <i class="fas fa-save"></i> Сохранить
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Модальное окно для смены пароля -->
                <div id="password-modal" class="modal">
                    <div class="modal-content modern-modal">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-key"></i>
                                <h3>Сменить пароль</h3>
                            </div>
                            <button class="modal-close" id="close-password-modal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="password-form" class="modern-form">
                                <div class="form-group">
                                    <label for="new-password">Новый пароль *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="new-password" name="new-password" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirm-new-password">Подтвердите новый пароль *</label>
                                    <div class="input-wrapper">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="confirm-new-password" name="confirm-new-password" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-modern" id="cancel-password-btn">
                                <i class="fas fa-times"></i> Отмена
                            </button>
                            <button type="button" class="btn btn-primary btn-modern" id="save-password-btn">
                                <i class="fas fa-save"></i> Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Страница настроек -->
            <div id="settings-page" class="page-content">
                <div class="settings-container">
                                            <h3>Подключение к базе данных</h3>
                    <form id="settings-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="db-host">Хост базы данных:</label>
                                <input type="text" id="db-host" name="database_host" required>
                            </div>
                            <div class="form-group">
                                <label for="db-port">Порт:</label>
                                <input type="text" id="db-port" name="database_port" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="db-name">Имя базы данных:</label>
                                <input type="text" id="db-name" name="database_name" required>
                            </div>
                            <div class="form-group">
                                <label for="db-user">Пользователь:</label>
                                <input type="text" id="db-user" name="database_user" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="db-password">Пароль:</label>
                            <input type="password" id="db-password" name="database_password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Сохранить
                            </button>
                            <button type="button" id="test-connection" class="btn btn-primary">
                                <i class="fas fa-plug"></i> Проверить подключение
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Настройки Impact -->
                <div class="impact-container">
                                            <h3>Расчет риска (Impact)</h3>
                    <form id="impact-form">
                        <div class="form-group">
                            <label for="impact-resource-criticality">Критичность ресурса:</label>
                            <select id="impact-resource-criticality" name="impact_resource_criticality" required>
                                <option value="Critical">Critical (0.33)</option>
                                <option value="High">High (0.25)</option>
                                <option value="Medium">Medium (0.15)</option>
                                <option value="None">None (0.1)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-confidential-data">Наличие конфиденциальных данных:</label>
                            <select id="impact-confidential-data" name="impact_confidential_data" required>
                                <option value="Есть">Есть (0.33)</option>
                                <option value="Отсутствуют">Отсутствуют (0.1)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-internet-access">Доступен из сети интернет:</label>
                            <select id="impact-internet-access" name="impact_internet_access" required>
                                <option value="Доступен">Доступен (0.33)</option>
                                <option value="Недоступен">Недоступен (0.1)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="risk-threshold">Порог риска (красная зона): <span id="threshold-value">75</span>%</label>
                            <input type="range" id="risk-threshold" name="risk_threshold" min="0" max="100" value="75" class="threshold-slider">
                            <div class="threshold-labels">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="max-concurrent-requests">Максимум одновременных запросов к БД:</label>
                            <input type="number" id="max-concurrent-requests" name="max_concurrent_requests" min="1" max="10" value="3" required>
                            <small>Рекомендуется: 1-5. Больше запросов = быстрее, но больше нагрузка на БД</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Сохранить Impact
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Настройки VM MaxPatrol -->
                <div class="vm-settings-container">
                                            <h3>Интеграция с MaxPatrol VM</h3>
                    <form id="vm-settings-form">
                        <div class="form-group">
                            <label for="vm-enabled">Включить интеграцию:</label>
                            <select id="vm-enabled" name="vm_enabled" required>
                                <option value="false">Отключено</option>
                                <option value="true">Включено</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vm-host">Хост VM:</label>
                            <input type="text" id="vm-host" name="vm_host" placeholder="msk01vm23.corp.local" required>
                            <small>Адрес сервера MaxPatrol VM</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-username">Имя пользователя:</label>
                            <input type="text" id="vm-username" name="vm_username" placeholder="username" required>
                            <small>Логин для доступа к VM API</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-password">Пароль:</label>
                            <input type="password" id="vm-password" name="vm_password" placeholder="password" required>
                            <small>Пароль для доступа к VM API</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-client-secret">Client Secret:</label>
                            <input type="password" id="vm-client-secret" name="vm_client_secret" placeholder="client_secret" required>
                            <small>Секретный ключ для OAuth2 аутентификации</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="vm-settings-btn">
                                <i class="fas fa-save"></i> Сохранить VM
                            </button>
                            <button type="button" id="vm-test-connection-btn" class="btn btn-info">
                                <i class="fas fa-plug"></i> Тест подключения
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Отдельный блок EPSS -->
                <div class="epss-container">
                    <h3>Загрузка базы EPSS</h3>
                    <form id="epss-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="epss-file">Загрузить CSV-файл:</label>
                            <input type="file" id="epss-file" name="file" accept=".csv" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="epss-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="epss-download-btn" class="btn btn-primary">
                                <i class="fas fa-cloud-download-alt"></i> <span class="btn-text">Скачать с сайта</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                        </div>
                    </form>
                    <div id="epss-status" style="margin-top:2rem;"></div>
                </div>
                
                <!-- Отдельный блок Exploit DB -->
                <div class="exploitdb-container">
                    <h3>Загрузка базы Exploit DB</h3>
                    <form id="exploitdb-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="exploitdb-file">Загрузить CSV-файл:</label>
                            <input type="file" id="exploitdb-file" name="file" accept=".csv" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="exploitdb-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="exploitdb-download-btn" class="btn btn-primary">
                                <i class="fas fa-cloud-download-alt"></i> <span class="btn-text">Скачать с сайта</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                        </div>
                    </form>
                    <div id="exploitdb-status" style="margin-top:2rem;"></div>
                </div>
                
                <!-- Секция очистки таблиц -->
                <div class="clear-container">
                    <h3>Очистка таблиц</h3>
                    <div class="clear-actions">
                        <div class="clear-item">
                            <h4>Хосты</h4>
                            <p>Удалить все записи хостов из базы данных</p>
                            <button type="button" id="clear-hosts-btn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Очистить хосты
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>EPSS</h4>
                            <p>Удалить все записи EPSS из базы данных</p>
                            <button type="button" id="clear-epss-btn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Очистить EPSS
                            </button>
                        </div>
                        <div class="clear-item">
                            <h4>ExploitDB</h4>
                            <p>Удалить все записи ExploitDB из базы данных</p>
                            <button type="button" id="clear-exploitdb-btn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Очистить ExploitDB
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Страница хостов -->
            <div id="hosts-page" class="page-content">
                <div class="hosts-container">
                    <h3>Импорт хостов из MP VM</h3>
                    <form id="hosts-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="hosts-file">Загрузить CSV-файл:</label>
                            <input type="file" id="hosts-file" name="file" accept=".csv" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="hosts-upload-btn">
                                <i class="fas fa-upload"></i> <span class="btn-text">Загрузить CSV</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                            <button type="button" id="update-hosts-data-btn" class="btn btn-warning">
                                <i class="fas fa-sync-alt"></i> <span class="btn-text">Обновить данные EPSS/Эксплойтов</span>
                                <i class="fas fa-spinner fa-spin" style="display:none;"></i>
                            </button>
                        </div>
                    </form>
                    <div id="hosts-status" style="margin-top:2rem;"></div>
                </div>
                
                <!-- Импорт из VM MaxPatrol -->
                <div class="vm-import-container">
                    <h3>Импорт хостов из MaxPatrol VM</h3>
                    <p class="vm-description">
                        Импортируйте хосты с уязвимостями из MaxPatrol VM через API.
                        Система автоматически получит данные и импортирует их в базу данных VulnAnalizer.
                    </p>
                    
                    <div class="vm-import-section">
                        <h4>Параметры импорта</h4>
                        <div class="form-group">
                            <label for="vm-os-filter">Дополнительный фильтр ОС (исключить):</label>
                            <input type="text" id="vm-os-filter" name="vm_os_filter" placeholder="macOS,Android,ChromeOS" value="">
                            <small>Дополнительные ОС через запятую для исключения. Базовые фильтры (Windows 7, Windows 10, ESXi, IOS, NX-OS, IOS XE, FreeBSD) применяются автоматически.</small>
                        </div>
                        <div class="form-group">
                            <label for="vm-limit">Лимит записей:</label>
                            <input type="number" id="vm-limit" name="vm_limit" placeholder="0" value="0" min="0" max="100000">
                            <small>0 = без лимита, иначе максимальное количество записей для импорта</small>
                        </div>
                        <div class="vm-import-info">
                            <p><strong>Последний импорт:</strong> <span id="vm-last-import">Не выполнялся</span></p>
                            <p><strong>Количество записей:</strong> <span id="vm-import-count">0</span></p>
                            <p><strong>Статус:</strong> <span id="vm-import-status">Не настроено</span></p>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="vm-import-btn" class="btn btn-success">
                                <i class="fas fa-download"></i> Импорт хостов из VM
                            </button>
                            <button type="button" id="vm-refresh-status-btn" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> Обновить статус
                            </button>
                        </div>
                    </div>
                    
                    <div id="vm-status" style="margin-top:2rem;"></div>
                </div>
            </div>




        </main>
    </div>

    <!-- Уведомления -->
    <div id="notifications" class="notifications"></div>

    <script src="/vulnanalizer/static/js/app.js?v=2.8"></script>
</body>
</html> 