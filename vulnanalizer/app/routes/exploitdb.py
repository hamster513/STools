"""
Роуты для работы с ExploitDB данными
"""
import traceback
from fastapi import APIRouter, HTTPException, File, UploadFile
from fastapi.responses import StreamingResponse

from database import get_db

router = APIRouter()


@router.post("/api/exploitdb/upload")
async def upload_exploitdb(file: UploadFile = File(...)):
    """Загрузить ExploitDB данные"""
    try:
        content = await file.read()
        decoded_content = content.decode('utf-8-sig')
        
        # Парсим CSV
        import csv
        lines = decoded_content.splitlines()
        reader = csv.DictReader(lines, delimiter=',')
        
        records = []
        for row in reader:
            try:
                cve = row.get('cve', '').strip()
                exploit_id = row.get('exploit_id', '').strip()
                
                if cve and exploit_id:
                    try:
                        exploit_id_value = int(exploit_id)
                        records.append({
                            'cve': cve,
                            'exploit_id': exploit_id_value
                        })
                    except ValueError:
                        print(f"⚠️ Пропускаем запись с невалидным Exploit ID: {cve} = {exploit_id}")
                        continue
                        
            except Exception as row_error:
                print(f"⚠️ Ошибка обработки строки ExploitDB: {row_error}")
                continue
        
        # Сохраняем в базу данных
        db = get_db()
        await db.insert_exploitdb_records(records)
        
        return {
            "success": True,
            "count": len(records),
            "message": f"ExploitDB данные успешно импортированы: {len(records)} записей"
        }
        
    except Exception as e:
        print(f'❌ ExploitDB upload error: {traceback.format_exc()}')
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/api/exploitdb/download")
async def download_exploitdb():
    """Скачать ExploitDB данные"""
    try:
        db = get_db()
        exploitdb_data = await db.get_all_exploitdb_records()
        
        if not exploitdb_data:
            raise HTTPException(status_code=404, detail="ExploitDB данные не найдены")
        
        # Создаем CSV
        import csv
        import io
        
        output = io.StringIO()
        writer = csv.writer(output)
        writer.writerow(['cve', 'exploit_id'])
        
        for record in exploitdb_data:
            writer.writerow([record['cve'], record['exploit_id']])
        
        output.seek(0)
        
        return StreamingResponse(
            io.BytesIO(output.getvalue().encode('utf-8')),
            media_type="text/csv",
            headers={"Content-Disposition": "attachment; filename=exploitdb_data.csv"}
        )
        
    except HTTPException:
        raise
    except Exception as e:
        print(f'❌ ExploitDB download error: {traceback.format_exc()}')
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/api/exploitdb/status")
async def exploitdb_status():
    """Получить статус ExploitDB данных"""
    try:
        db = get_db()
        count = await db.count_exploitdb_records()
        return {"success": True, "count": count}
    except Exception as e:
        print('ExploitDB status error:', traceback.format_exc())
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/api/exploitdb/clear")
async def clear_exploitdb():
    """Очистить все ExploitDB данные"""
    try:
        db = get_db()
        await db.clear_exploitdb()
        return {"success": True, "message": "Все ExploitDB данные удалены"}
    except Exception as e:
        print('ExploitDB clear error:', traceback.format_exc())
        raise HTTPException(status_code=500, detail=str(e))
