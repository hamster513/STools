"""
–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–∞ –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
"""


def calculate_risk_score(epss: float, cvss: float = None, criticality: str = 'Medium', 
                        settings: dict = None, cve_data: dict = None, 
                        confidential_data: bool = False, internet_access: bool = False) -> dict:
    """
    –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
    Risk = EPSS √ó (CVSS √∑ 10) √ó Impact √ó CVE_param √ó ExDB_param √ó MSF_param
    
    Args:
        epss: EPSS score
        cvss: CVSS score
        criticality: –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–∞ (Critical, High, Medium, Low, None)
        settings: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
        cve_data: –î–∞–Ω–Ω—ã–µ CVE (CVSS v3/v2 –º–µ—Ç—Ä–∏–∫–∏, ExploitDB —Ç–∏–ø, Metasploit —Ä–∞–Ω–≥)
        confidential_data: –ï—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        internet_access: –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    
    Returns:
        dict: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏
    """
    if epss is None:
        return {
            'raw_risk': None,
            'risk_score': None,
            'calculation_possible': False,
            'impact': None,
            'cve_param': None,
            'exdb_param': None,
            'msf_param': None,
            'formula_components': None
        }
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º decimal –≤ float –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if hasattr(epss, 'as_tuple'):
        epss = float(epss)
    
    # –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç Impact –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    impact = _calculate_impact_full(criticality, settings, confidential_data, internet_access)
    
    # –†–∞—Å—á–µ—Ç CVE_param
    cve_param = _calculate_cve_param(cve_data, settings)
    
    # –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞: Risk = EPSS √ó (CVSS √∑ 10) √ó Impact √ó CVE_param √ó ExDB_param √ó MSF_param
    cvss_factor = (cvss / 10) if cvss is not None else 1.0
    
    # –ü–æ–ª—É—á–∞–µ–º ExDB_param –∏ MSF_param
    exdb_param = _calculate_exdb_param(cve_data, settings)
    msf_param = _calculate_msf_param(cve_data, settings)
    
    raw_risk = epss * cvss_factor * impact * cve_param * exdb_param * msf_param
    risk_score = round(min(1, raw_risk) * 100)
    
    # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è CVE-2017-0144
    if cve_data and cve_data.get('cve_id') == 'CVE-2017-0144':
        print(f"üîç DEBUG CVE-2017-0144: epss={epss}, cvss_factor={cvss_factor}, impact={impact}")
        print(f"üîç DEBUG CVE-2017-0144: cve_param={cve_param}, exdb_param={exdb_param}, msf_param={msf_param}")
        print(f"üîç DEBUG CVE-2017-0144: raw_risk={raw_risk}, risk_score={risk_score}")
        print(f"üîç DEBUG CVE-2017-0144: cve_data={cve_data}")
        print(f"üîç DEBUG CVE-2017-0144: settings keys={list(settings.keys()) if settings else 'None'}")
        if settings:
            exploitdb_keys = [k for k in settings.keys() if 'exploitdb' in k]
            metasploit_keys = [k for k in settings.keys() if 'metasploit' in k]
            print(f"üîç DEBUG CVE-2017-0144: exploitdb settings={exploitdb_keys}")
            print(f"üîç DEBUG CVE-2017-0144: metasploit settings={metasploit_keys}")
    
    return {
        'raw_risk': raw_risk,
        'risk_score': risk_score,
        'calculation_possible': True,
        'impact': impact,
        'cve_param': cve_param,
        'exdb_param': exdb_param,
        'msf_param': msf_param,
        'formula_components': {
            'epss': epss,
            'cvss': cvss,
            'cvss_factor': cvss_factor,
            'impact': impact,
            'cve_param': cve_param,
            'exdb_param': exdb_param,
            'msf_param': msf_param
        }
    }


def _calculate_impact_full(criticality: str, settings: dict = None, confidential_data: bool = False, internet_access: bool = False) -> float:
    """–ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç Impact —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤"""
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Impact –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if not settings:
        settings = {}
    
    impact_settings = settings.get('impact', {})
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    default_impact = {
        'resource_criticality': {
            'Critical': 0.33, 'High': 0.25, 'Medium': 0.2, 'Low': 0.1, 'None': 0.2
        },
        'confidential_data': {
            '–ï—Å—Ç—å': 0.33, '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç': 0.2
        },
        'internet_access': {
            '–î–æ—Å—Ç—É–ø–µ–Ω': 0.33, '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω': 0.2
        }
    }
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    for key, value in default_impact.items():
        if key not in impact_settings:
            impact_settings[key] = value
    
    # –†–∞—Å—á–µ—Ç Impact –∫–∞–∫ —Å—É–º–º—ã –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    resource_impact = impact_settings['resource_criticality'].get(criticality, 0.2)
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º boolean –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    confidential_str = '–ï—Å—Ç—å' if confidential_data else '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'
    internet_str = '–î–æ—Å—Ç—É–ø–µ–Ω' if internet_access else '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    
    confidential_impact = impact_settings['confidential_data'].get(confidential_str, 0.2)
    internet_impact = impact_settings['internet_access'].get(internet_str, 0.2)
    
    total_impact = resource_impact + confidential_impact + internet_impact
    
    return total_impact


def _calculate_cve_param(cve_data: dict = None, settings: dict = None) -> float:
    """–†–∞—Å—á–µ—Ç CVE_param –Ω–∞ –æ—Å–Ω–æ–≤–µ CVSS –º–µ—Ç—Ä–∏–∫"""
    if not cve_data or not settings:
        return 1.0
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CVE –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    cve_settings = settings.get('cve', {})
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è CVSS v3
    default_cve_v3 = {
        'attack_vector': {'NETWORK': 1.2, 'ADJACENT_NETWORK': 1.1, 'LOCAL': 1.0, 'PHYSICAL': 0.9},
        'privileges_required': {'NONE': 1.2, 'LOW': 1.1, 'HIGH': 1.0},
        'user_interaction': {'NONE': 1.2, 'REQUIRED': 1.0}
    }
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è CVSS v2
    default_cve_v2 = {
        'access_vector': {'NETWORK': 1.2, 'ADJACENT_NETWORK': 1.1, 'LOCAL': 1.0},
        'access_complexity': {'LOW': 1.2, 'MEDIUM': 1.1, 'HIGH': 1.0},
        'authentication': {'NONE': 1.2, 'SINGLE': 1.1, 'MULTIPLE': 1.0}
    }
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    cve_v3_settings = cve_settings.get('cvss_v3', default_cve_v3)
    cve_v2_settings = cve_settings.get('cvss_v2', default_cve_v2)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º CVSS v3 –º–µ—Ç—Ä–∏–∫–∏
    if cve_data.get('cvss_v3_attack_vector'):
        attack_vector = cve_data['cvss_v3_attack_vector']
        privileges_required = cve_data.get('cvss_v3_privileges_required', 'NONE')
        user_interaction = cve_data.get('cvss_v3_user_interaction', 'NONE')
        
        attack_mult = cve_v3_settings['attack_vector'].get(attack_vector, 1.0)
        priv_mult = cve_v3_settings['privileges_required'].get(privileges_required, 1.0)
        user_mult = cve_v3_settings['user_interaction'].get(user_interaction, 1.0)
        
        return attack_mult * priv_mult * user_mult
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º CVSS v2 –º–µ—Ç—Ä–∏–∫–∏
    elif cve_data.get('cvss_v2_access_vector'):
        access_vector = cve_data['cvss_v2_access_vector']
        access_complexity = cve_data.get('cvss_v2_access_complexity', 'LOW')
        authentication = cve_data.get('cvss_v2_authentication', 'NONE')
        
        vector_mult = cve_v2_settings['access_vector'].get(access_vector, 1.0)
        complexity_mult = cve_v2_settings['access_complexity'].get(access_complexity, 1.0)
        auth_mult = cve_v2_settings['authentication'].get(authentication, 1.0)
        
        return vector_mult * complexity_mult * auth_mult
    
    return 1.0


def _calculate_exdb_param(cve_data: dict = None, settings: dict = None) -> float:
    """–†–∞—Å—á–µ—Ç ExDB_param –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞ ExploitDB"""
    if not cve_data or not cve_data.get('exploitdb_type'):
        return 1.0
    
    exploit_type = cve_data['exploitdb_type']
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ExploitDB –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if not settings:
        settings = {}
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    default_exdb = {
        'remote': 0.8,
        'webapps': 0.85,
        'dos': 0.8,
        'local': 0.9,
        'hardware': 0.7
    }
    
    # –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    exdb_settings = {}
    for key in default_exdb.keys():
        setting_key = f'exploitdb_{key}'
        if setting_key in settings:
            exdb_settings[key] = float(settings[setting_key])
        else:
            exdb_settings[key] = default_exdb[key]
    
    # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è CVE-2017-0144
    if cve_data and cve_data.get('cve_id') == 'CVE-2017-0144':
        print(f"üîç DEBUG _calculate_exdb_param: exploit_type={exploit_type}")
        print(f"üîç DEBUG _calculate_exdb_param: exdb_settings={exdb_settings}")
        print(f"üîç DEBUG _calculate_exdb_param: result={exdb_settings.get(exploit_type, 1.0)}")
    
    return exdb_settings.get(exploit_type, 1.0)


def _calculate_msf_param(cve_data: dict = None, settings: dict = None) -> float:
    """–†–∞—Å—á–µ—Ç MSF_param –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–Ω–≥–∞ Metasploit"""
    if not cve_data or not cve_data.get('msf_rank'):
        return 1.0
    
    msf_rank = cve_data['msf_rank']
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Metasploit –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if not settings:
        settings = {}
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    default_msf = {
        'excellent': 1.3,
        'good': 1.1,
        'normal': 1.0,
        'average': 0.9,
        'low': 0.8,
        'unknown': 1.0,
        'manual': 0.7
    }
    
    # –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    msf_settings = {}
    for key in default_msf.keys():
        setting_key = f'metasploit_{key}'
        if setting_key in settings:
            msf_settings[key] = float(settings[setting_key])
        else:
            msf_settings[key] = default_msf[key]
    
    # –ï—Å–ª–∏ msf_rank - —á–∏—Å–ª–æ, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
    if isinstance(msf_rank, (int, float)):
        # –ú–∞–ø–ø–∏–Ω–≥ —á–∏—Å–ª–æ–≤—ã—Ö —Ä–∞–Ω–≥–æ–≤ Metasploit –≤ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ
        if msf_rank >= 1000:
            msf_rank = 'excellent'
        elif msf_rank >= 500:
            msf_rank = 'good'
        elif msf_rank >= 300:
            msf_rank = 'normal'
        elif msf_rank >= 200:
            msf_rank = 'average'
        elif msf_rank >= 100:
            msf_rank = 'low'
        else:
            msf_rank = 'unknown'
    
    return msf_settings.get(msf_rank, 1.0)
