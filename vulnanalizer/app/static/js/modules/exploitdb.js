/**
 * –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ExploitDB
 */
class ExploitDBModule {
    constructor(app) {
        this.app = app;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateStatus();
    }

    setupEventListeners() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ CSV
        const exploitdbForm = document.getElementById('exploitdb-upload-form');
        if (exploitdbForm) {
            exploitdbForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.uploadExploitDB();
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å —Å–∞–π—Ç–∞
        const exploitdbDownloadBtn = document.getElementById('exploitdb-download-btn');
        if (exploitdbDownloadBtn) {
            exploitdbDownloadBtn.addEventListener('click', async () => {
                await this.downloadExploitDB();
            });
        }

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        const exploitdbPreviewBtn = document.getElementById('exploitdb-preview-btn');
        if (exploitdbPreviewBtn) {
            exploitdbPreviewBtn.addEventListener('click', () => {
                this.showExploitDBPreview();
            });
        }
    }

    async updateStatus() {
        try {
            const data = await this.app.api.getExploitDBStatus();
            
            if (data.success) {
                const statusDiv = document.getElementById('exploitdb-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div class="status-info">
                                <i class="fas fa-database"></i>
                                <span>–ó–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ: <strong>${data.count}</strong></span>
                            </div>
                        </div>
                        
                        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å —Å—Å—ã–ª–∫–∞–º–∏ –¥–ª—è ExploitDB -->
                        <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; font-size: 0.875rem;">
                            <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; font-weight: 600; color: #1e293b;">üìã –°—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ExploitDB</h4>
                            <p style="margin: 0 0 8px 0; line-height: 1.4;">–î–ª—è offline –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏:</p>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <a href="https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv" target="_blank" style="display: flex; align-items: center; gap: 6px; color: #2563eb; text-decoration: none; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;">
                                    üîó <span style="flex: 1;">ExploitDB Files (–æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞)</span>
                                    <span style="font-size: 0.7rem; color: #64748b; font-style: italic;">~10MB</span>
                                </a>
                                <a href="https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_shellcodes.csv" target="_blank" style="display: flex; align-items: center; gap: 6px; color: #2563eb; text-decoration: none; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;">
                                    üîó <span style="flex: 1;">ExploitDB Shellcodes</span>
                                    <span style="font-size: 0.7rem; color: #64748b; font-style: italic;">~220KB</span>
                                </a>
                                <a href="https://github.com/offensive-security/exploitdb" target="_blank" style="display: flex; align-items: center; gap: 6px; color: #2563eb; text-decoration: none; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;">
                                    üì¶ <span style="flex: 1;">GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ExploitDB</span>
                                </a>
                                <a href="https://www.exploit-db.com/" target="_blank" style="display: flex; align-items: center; gap: 6px; color: #2563eb; text-decoration: none; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;">
                                    üåê <span style="flex: 1;">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç ExploitDB</span>
                                </a>
                            </div>
                        </div>
                    `;
                }
            } else {
                const statusDiv = document.getElementById('exploitdb-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="status-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞</span>
                        </div>
                    `;
                }
            }
        } catch (err) {
            const statusDiv = document.getElementById('exploitdb-status');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="status-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞</span>
                    </div>
                `;
            }
        }
    }

    async uploadExploitDB() {
        const fileInput = document.getElementById('exploitdb-file');
        if (!fileInput.files.length) {
            if (this.app.notifications && this.app.notifications.show) {
                this.app.notifications.show('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
            }
            return;
        }
        
        const uploadBtn = document.getElementById('exploitdb-upload-btn');
        const btnText = uploadBtn.querySelector('.btn-text');
        const spinner = uploadBtn.querySelector('.fa-spinner');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btnText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        spinner.style.display = 'inline-block';
        uploadBtn.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Å—Ç–∞—Ç—É—Å–±–∞—Ä–µ
        this.showOperationProgress('exploitdb', '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ExploitDB...', 0);
        
        try {
            this.updateOperationProgress('exploitdb', '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ ExploitDB...', 25, '–ß—Ç–µ–Ω–∏–µ CSV —Ñ–∞–π–ª–∞...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            this.updateOperationProgress('exploitdb', '–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...', 50, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø–∏—Å–µ–π...');
            await new Promise(resolve => setTimeout(resolve, 800));
            
            this.updateOperationProgress('exploitdb', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É...', 75, '–ó–∞–ø–∏—Å—å —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
            
            const data = await this.app.api.uploadExploitDB(fileInput.files[0]);
            
            if (data.success) {
                this.updateOperationProgress('exploitdb', '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...', 90, '–§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.showOperationComplete('exploitdb', 'ExploitDB –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.count}`);
                if (this.app.notifications && this.app.notifications.show) {
                    this.app.notifications.show(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.count}`, 'success');
                }
                this.updateStatus();
                fileInput.value = '';
            } else {
                this.showOperationError('exploitdb', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ExploitDB', data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                if (this.app.notifications && this.app.notifications.show) {
                    this.app.notifications.show('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ExploitDB', 'error');
                }
            }
        } catch (err) {
            this.showOperationError('exploitdb', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ExploitDB', err.message);
            if (this.app.notifications && this.app.notifications.show) {
                this.app.notifications.show('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ExploitDB', 'error');
            }
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            btnText.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV';
            spinner.style.display = 'none';
            uploadBtn.disabled = false;
        }
    }

    async downloadExploitDB() {
        const exploitdbDownloadBtn = document.getElementById('exploitdb-download-btn');
        const btnText = exploitdbDownloadBtn.querySelector('.btn-text');
        const spinner = exploitdbDownloadBtn.querySelector('.fa-spinner');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btnText.textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...';
        spinner.style.display = 'inline-block';
        exploitdbDownloadBtn.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Å—Ç–∞—Ç—É—Å–±–∞—Ä–µ
        this.showOperationProgress('exploitdb', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitLab...', 0);
        
        try {
            this.updateOperationProgress('exploitdb', '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...', 25, '–ó–∞–≥—Ä—É–∑–∫–∞ —Å gitlab.com...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            this.updateOperationProgress('exploitdb', '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 50, '–ü–∞—Ä—Å–∏–Ω–≥ CSV —Ñ–∞–π–ª–∞ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤...');
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            this.updateOperationProgress('exploitdb', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É...', 75, '–ó–∞–ø–∏—Å—å —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
            
            const data = await this.app.api.downloadExploitDB();
            
            if (data.success) {
                this.updateOperationProgress('exploitdb', '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...', 90, '–§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.showOperationComplete('exploitdb', 'ExploitDB –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω—ã', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.count}`);
                if (this.app.notifications && this.app.notifications.show) {
                    this.app.notifications.show(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.count}`, 'success');
                }
                this.updateStatus();
            } else {
                this.showOperationError('exploitdb', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ExploitDB', data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                if (this.app.notifications && this.app.notifications.show) {
                    this.app.notifications.show('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ExploitDB', 'error');
                }
            }
        } catch (err) {
            this.showOperationError('exploitdb', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ExploitDB', err.message);
            if (this.app.notifications && this.app.notifications.show) {
                this.app.notifications.show('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ExploitDB', 'error');
            }
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            btnText.textContent = '–°–∫–∞—á–∞—Ç—å —Å —Å–∞–π—Ç–∞';
            spinner.style.display = 'none';
            exploitdbDownloadBtn.disabled = false;
        }
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π
    showOperationProgress(operationId, message, progress = null) {
        const statusDiv = document.getElementById(`${operationId}-status`);
        if (!statusDiv) return;
        
        let progressHtml = '';
        if (progress !== null) {
            progressHtml = `
                <div class="operation-progress-bar">
                    <div class="operation-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="operation-progress-text">${progress.toFixed(1)}%</div>
            `;
        }
        
        statusDiv.innerHTML = `
            <div class="operation-status active">
                <div class="status-header">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span class="status-message">${message}</span>
                </div>
                ${progressHtml}
                <div class="status-details">
                    <small>–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</small>
                </div>
            </div>
        `;
    }

    updateOperationProgress(operationId, message, progress = null, details = null) {
        const statusDiv = document.getElementById(`${operationId}-status`);
        if (!statusDiv) return;
        
        let progressHtml = '';
        if (progress !== null) {
            progressHtml = `
                <div class="operation-progress-bar">
                    <div class="operation-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="operation-progress-text">${progress.toFixed(1)}%</div>
            `;
        }
        
        let detailsHtml = '';
        if (details) {
            detailsHtml = `<div class="status-details"><small>${details}</small></div>`;
        }
        
        statusDiv.innerHTML = `
            <div class="operation-status active">
                <div class="status-header">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span class="status-message">${message}</span>
                </div>
                ${progressHtml}
                ${detailsHtml}
            </div>
        `;
    }

    showOperationComplete(operationId, message, details = null) {
        const statusDiv = document.getElementById(`${operationId}-status`);
        if (!statusDiv) return;
        
        let detailsHtml = '';
        if (details) {
            detailsHtml = `<div class="status-details"><small>${details}</small></div>`;
        }
        
        statusDiv.innerHTML = `
            <div class="operation-status success">
                <div class="status-header">
                    <i class="fas fa-check-circle"></i>
                    <span class="status-message">${message}</span>
                </div>
                ${detailsHtml}
            </div>
        `;
    }

    showOperationError(operationId, message, error = null) {
        const statusDiv = document.getElementById(`${operationId}-status`);
        if (!statusDiv) return;
        
        let errorHtml = '';
        if (error) {
            errorHtml = `<div class="status-details"><small class="error-text">${error}</small></div>`;
        }
        
        statusDiv.innerHTML = `
            <div class="operation-status error">
                <div class="status-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="status-message">${message}</span>
                </div>
                ${errorHtml}
            </div>
        `;
    }

    showExploitDBPreview() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if (this.app.exploitdbModal) {
            this.app.exploitdbModal.show();
        } else {
        }
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –º–æ–¥—É–ª—è
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ExploitDBModule;
} else {
    window.ExploitDBModule = ExploitDBModule;
}
