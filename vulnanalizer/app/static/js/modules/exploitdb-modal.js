/**
 * Модуль для работы с модальным окном ExploitDB
 */
class ExploitDBModalModule {
    constructor(app) {
        this.app = app;
        this.modal = null;
        this.init();
    }

    init() {
        this.modal = document.getElementById('exploitdb-modal');
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Закрытие модального окна по клику на X
        const closeBtn = document.getElementById('exploitdb-modal-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.hide();
            });
        }

        // Закрытие модального окна по клику вне его
        if (this.modal) {
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) {
                    this.hide();
                }
            });
        }

        // Закрытие по Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modal && this.modal.style.display !== 'none') {
                this.hide();
            }
        });
    }

    show() {
        if (!this.modal) return;

        // Показываем модальное окно
        this.modal.style.display = 'block';
        this.modal.classList.add('show');

        // Показываем загрузку
        this.showLoading();

        // Загружаем данные ExploitDB
        this.loadExploitDBData();
    }

    hide() {
        if (!this.modal) return;

        this.modal.style.display = 'none';
        this.modal.classList.remove('show');
    }

    showLoading() {
        const loading = document.getElementById('exploitdb-modal-loading');
        const content = document.getElementById('exploitdb-modal-content');
        const error = document.getElementById('exploitdb-modal-error');

        if (loading) loading.style.display = 'block';
        if (content) content.style.display = 'none';
        if (error) error.style.display = 'none';
    }

    showError(message) {
        const loading = document.getElementById('exploitdb-modal-loading');
        const content = document.getElementById('exploitdb-modal-content');
        const error = document.getElementById('exploitdb-modal-error');
        const errorMessage = document.getElementById('exploitdb-error-message');

        if (loading) loading.style.display = 'none';
        if (content) content.style.display = 'none';
        if (error) error.style.display = 'block';
        if (errorMessage) errorMessage.textContent = message;
    }

    showContent() {
        const loading = document.getElementById('exploitdb-modal-loading');
        const content = document.getElementById('exploitdb-modal-content');
        const error = document.getElementById('exploitdb-modal-error');

        if (loading) loading.style.display = 'none';
        if (content) content.style.display = 'block';
        if (error) error.style.display = 'none';
    }

    async loadExploitDBData() {
        try {
            const response = await fetch(`${this.app.getApiBasePath()}/exploitdb/preview`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();

            if (result.success) {
                this.displayExploitDBData(result.records);
                this.showContent();
            } else {
                throw new Error(result.error || 'Ошибка загрузки данных');
            }
        } catch (error) {
            console.error('Error loading ExploitDB data:', error);
            this.showError(error.message);
        }
    }

    displayExploitDBData(records) {
        const tableBody = document.getElementById('exploitdb-table-body');
        const countSpan = document.getElementById('exploitdb-count');
        
        if (!tableBody || !countSpan) return;

        // Обновляем счетчик
        countSpan.textContent = records.length;

        // Очищаем таблицу
        tableBody.innerHTML = '';

        // Добавляем строки с данными
        records.forEach(record => {
            const row = document.createElement('tr');
            
            // Форматируем даты
            const datePublished = record.date_published ? new Date(record.date_published).toLocaleDateString('ru-RU') : '-';
            
            // Обрезаем длинные тексты
            const description = record.description ? (record.description.length > 60 ? record.description.substring(0, 60) + '...' : record.description) : '-';
            const filePath = record.file_path ? (record.file_path.length > 40 ? record.file_path.substring(0, 40) + '...' : record.file_path) : '-';
            
            // Форматируем verified статус
            const verifiedBadge = record.verified ? 
                '<span class="exploit-verified true">Verified</span>' : 
                '<span class="exploit-verified false">Not Verified</span>';
            
            row.innerHTML = `
                <td><strong>${record.exploit_id || '-'}</strong></td>
                <td title="${record.file_path || ''}">${filePath}</td>
                <td title="${record.description || ''}">${description}</td>
                <td>${record.type || '-'}</td>
                <td>${record.platform || '-'}</td>
                <td>${datePublished}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
}

// Экспорт модуля
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ExploitDBModalModule;
} else {
    window.ExploitDBModalModule = ExploitDBModalModule;
}
