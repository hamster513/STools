# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
# –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç: EPSS, ExploitDB, Metasploit, CVE (–≤—Å–µ –≥–æ–¥–∞)
# –ù–∞ –≤—ã—Ö–æ–¥–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è ZIP –∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
$ErrorActionPreference = "Stop"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
}

Write-ColorOutput "========================================" "Cyan"
Write-ColorOutput "  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π" "Cyan"
Write-ColorOutput "========================================" "Cyan"
Write-Host ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$workDir = "vulnerability_databases_$timestamp"
New-Item -ItemType Directory -Path $workDir -Force | Out-Null

Write-ColorOutput "‚úì –°–æ–∑–¥–∞–Ω–∞ —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $workDir" "Green"
Write-Host ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
function Download-File {
    param(
        [string]$Url,
        [string]$Output,
        [string]$Description
    )
    
    Write-ColorOutput "‚Üí –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: $Description" "Yellow"
    Write-Host "  URL: $Url"
    
    try {
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º WebClient –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        $webClient = New-Object System.Net.WebClient
        $webClient.DownloadFile($Url, $Output)
        
        $size = (Get-Item $Output).Length / 1MB
        $sizeStr = "{0:N2} MB" -f $size
        Write-ColorOutput "‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: $Output ($sizeStr)" "Green"
        return $true
    }
    catch {
        Write-ColorOutput "‚úó –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: $Description" "Red"
        Write-ColorOutput "  –û—à–∏–±–∫–∞: $_" "Red"
        return $false
    }
}

# 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ EPSS
Write-ColorOutput "[1/4] EPSS - Exploit Prediction Scoring System" "Cyan"
New-Item -ItemType Directory -Path "$workDir\epss" -Force | Out-Null
Download-File `
    -Url "https://epss.cyentia.com/epss_scores-current.csv.gz" `
    -Output "$workDir\epss\epss_scores-current.csv.gz" `
    -Description "EPSS —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ"
Write-Host ""

# 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ ExploitDB
Write-ColorOutput "[2/4] ExploitDB - –ë–∞–∑–∞ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤" "Cyan"
New-Item -ItemType Directory -Path "$workDir\exploitdb" -Force | Out-Null
Download-File `
    -Url "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv" `
    -Output "$workDir\exploitdb\files_exploits.csv" `
    -Description "ExploitDB –±–∞–∑–∞ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤"
Write-Host ""

# 3. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Metasploit
Write-ColorOutput "[3/4] Metasploit - –ë–∞–∑–∞ –º–æ–¥—É–ª–µ–π" "Cyan"
New-Item -ItemType Directory -Path "$workDir\metasploit" -Force | Out-Null
Download-File `
    -Url "https://raw.githubusercontent.com/rapid7/metasploit-framework/master/db/modules_metadata_base.json" `
    -Output "$workDir\metasploit\modules_metadata_base.json" `
    -Description "Metasploit –º–æ–¥—É–ª–∏"
Write-Host ""

# 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CVE (NVD)
Write-ColorOutput "[4/4] CVE - National Vulnerability Database" "Cyan"
New-Item -ItemType Directory -Path "$workDir\cve" -Force | Out-Null

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–æ–≤ (—Å 2002 –ø–æ —Ç–µ–∫—É—â–∏–π –≥–æ–¥)
$currentYear = (Get-Date).Year
$startYear = 2002

Write-Host "  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CVE —Å $startYear –ø–æ $currentYear –≥–æ–¥..."
Write-Host ""

$totalYears = $currentYear - $startYear + 1
$current = 0

for ($year = $startYear; $year -le $currentYear; $year++) {
    $current++
    Write-ColorOutput "‚Üí [$current/$totalYears] CVE $year" "Yellow"
    
    $success = Download-File `
        -Url "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-$year.json.gz" `
        -Output "$workDir\cve\nvdcve-2.0-$year.json.gz" `
        -Description "CVE $year"
    
    if (-not $success) {
        Write-ColorOutput "  ‚ö† –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–æ–¥ $year" "Yellow"
    }
    
    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä NVD
    Start-Sleep -Seconds 1
}

Write-Host ""
Write-ColorOutput "========================================" "Cyan"
Write-ColorOutput "  –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞" "Cyan"
Write-ColorOutput "========================================" "Cyan"
Write-Host ""

# –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
$archiveName = "vulnerability_databases_$timestamp.zip"
Write-ColorOutput "‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: $archiveName" "Yellow"

try {
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π .NET –∫–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ZIP
    Add-Type -AssemblyName System.IO.Compression.FileSystem
    [System.IO.Compression.ZipFile]::CreateFromDirectory($workDir, $archiveName)
    
    $archiveSize = (Get-Item $archiveName).Length / 1MB
    $archiveSizeStr = "{0:N2} MB" -f $archiveSize
    Write-ColorOutput "‚úì –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $archiveName ($archiveSizeStr)" "Green"
}
catch {
    Write-ColorOutput "‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: $_" "Red"
    exit 1
}

Write-Host ""
Write-ColorOutput "========================================" "Cyan"
Write-ColorOutput "  –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤" "Cyan"
Write-ColorOutput "========================================" "Cyan"
Write-Host ""

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
Write-ColorOutput "‚Üí –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $workDir" "Yellow"
Remove-Item -Path $workDir -Recurse -Force
Write-ColorOutput "‚úì –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã" "Green"

Write-Host ""
Write-ColorOutput "========================================" "Green"
Write-ColorOutput "  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!" "Green"
Write-ColorOutput "========================================" "Green"
Write-Host ""
Write-Host "üì¶ –ê—Ä—Ö–∏–≤: $archiveName"
Write-Host "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
Write-Host "   ‚Ä¢ EPSS - —Ç–µ–∫—É—â–∏–µ –æ—Ü–µ–Ω–∫–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏"
Write-Host "   ‚Ä¢ ExploitDB - –±–∞–∑–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤"
Write-Host "   ‚Ä¢ Metasploit - –º–æ–¥—É–ª–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ Metasploit"
Write-Host "   ‚Ä¢ CVE - –ø–æ–ª–Ω–∞—è –±–∞–∑–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π NVD ($startYear-$currentYear)"
Write-Host ""
Write-Host "üöÄ –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å VulnAnalizer"
Write-Host ""

