#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
# –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç: EPSS, ExploitDB, Metasploit, CVE (–≤—Å–µ –≥–æ–¥–∞)
# –ù–∞ –≤—ã—Ö–æ–¥–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è ZIP –∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
WORK_DIR="vulnerability_databases_${TIMESTAMP}"
mkdir -p "$WORK_DIR"

echo -e "${GREEN}‚úì${NC} –°–æ–∑–¥–∞–Ω–∞ —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${WORK_DIR}"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
download_file() {
    local url=$1
    local output=$2
    local description=$3
    
    echo -e "${YELLOW}‚Üí${NC} –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${description}"
    echo -e "  URL: ${url}"
    
    if curl -L --progress-bar -o "$output" "$url"; then
        local size=$(du -h "$output" | cut -f1)
        echo -e "${GREEN}‚úì${NC} –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${output} (${size})"
        return 0
    else
        echo -e "${RED}‚úó${NC} –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${description}"
        return 1
    fi
}

# 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ EPSS
echo -e "${BLUE}[1/4] EPSS - Exploit Prediction Scoring System${NC}"
mkdir -p "$WORK_DIR/epss"
download_file \
    "https://epss.cyentia.com/epss_scores-current.csv.gz" \
    "$WORK_DIR/epss/epss_scores-current.csv.gz" \
    "EPSS —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ"
echo ""

# 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ ExploitDB
echo -e "${BLUE}[2/4] ExploitDB - –ë–∞–∑–∞ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤${NC}"
mkdir -p "$WORK_DIR/exploitdb"
download_file \
    "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv" \
    "$WORK_DIR/exploitdb/files_exploits.csv" \
    "ExploitDB –±–∞–∑–∞ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤"
echo ""

# 3. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Metasploit
echo -e "${BLUE}[3/4] Metasploit - –ë–∞–∑–∞ –º–æ–¥—É–ª–µ–π${NC}"
mkdir -p "$WORK_DIR/metasploit"
download_file \
    "https://raw.githubusercontent.com/rapid7/metasploit-framework/master/db/modules_metadata_base.json" \
    "$WORK_DIR/metasploit/modules_metadata_base.json" \
    "Metasploit –º–æ–¥—É–ª–∏"
echo ""

# 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CVE (NVD)
echo -e "${BLUE}[4/4] CVE - National Vulnerability Database${NC}"
mkdir -p "$WORK_DIR/cve"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–æ–≤ (—Å 2002 –ø–æ —Ç–µ–∫—É—â–∏–π –≥–æ–¥)
CURRENT_YEAR=$(date +%Y)
START_YEAR=2002

echo -e "  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CVE —Å ${START_YEAR} –ø–æ ${CURRENT_YEAR} –≥–æ–¥..."
echo ""

TOTAL_YEARS=$((CURRENT_YEAR - START_YEAR + 1))
CURRENT=0

for year in $(seq $START_YEAR $CURRENT_YEAR); do
    CURRENT=$((CURRENT + 1))
    echo -e "${YELLOW}‚Üí${NC} [${CURRENT}/${TOTAL_YEARS}] CVE ${year}"
    
    download_file \
        "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${year}.json.gz" \
        "$WORK_DIR/cve/nvdcve-2.0-${year}.json.gz" \
        "CVE ${year}"
    
    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä NVD
    sleep 1
done

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
ARCHIVE_NAME="vulnerability_databases_${TIMESTAMP}.zip"
echo -e "${YELLOW}‚Üí${NC} –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${ARCHIVE_NAME}"

if command -v zip &> /dev/null; then
    zip -r -q "$ARCHIVE_NAME" "$WORK_DIR"
    ARCHIVE_SIZE=$(du -h "$ARCHIVE_NAME" | cut -f1)
    echo -e "${GREEN}‚úì${NC} –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${ARCHIVE_NAME} (${ARCHIVE_SIZE})"
else
    echo -e "${RED}‚úó${NC} –ö–æ–º–∞–Ω–¥–∞ 'zip' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ tar:"
    tar -czf "${ARCHIVE_NAME%.zip}.tar.gz" "$WORK_DIR"
    ARCHIVE_SIZE=$(du -h "${ARCHIVE_NAME%.zip}.tar.gz" | cut -f1)
    echo -e "${GREEN}‚úì${NC} –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${ARCHIVE_NAME%.zip}.tar.gz (${ARCHIVE_SIZE})"
fi

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo -e "${YELLOW}‚Üí${NC} –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: ${WORK_DIR}"
rm -rf "$WORK_DIR"
echo -e "${GREEN}‚úì${NC} –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "üì¶ –ê—Ä—Ö–∏–≤: ${ARCHIVE_NAME}"
echo -e "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
echo -e "   ‚Ä¢ EPSS - —Ç–µ–∫—É—â–∏–µ –æ—Ü–µ–Ω–∫–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏"
echo -e "   ‚Ä¢ ExploitDB - –±–∞–∑–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤"
echo -e "   ‚Ä¢ Metasploit - –º–æ–¥—É–ª–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ Metasploit"
echo -e "   ‚Ä¢ CVE - –ø–æ–ª–Ω–∞—è –±–∞–∑–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π NVD (${START_YEAR}-${CURRENT_YEAR})"
echo ""
echo -e "üöÄ –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å VulnAnalizer"
echo ""

